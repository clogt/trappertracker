<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrapperTracker - Pet Safety Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <style>
        #map {
            height: calc(100vh - 200px);
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans dark:text-gray-50">
    <header class="bg-white dark:bg-gray-800 shadow">
        <div class="container mx-auto p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-white">TrapperTracker</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Real-time Pet Safety Alert Map</p>
                </div>
                <nav class="flex space-x-4 items-center">
                    <a href="/advanced.html" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 px-3 py-2">Advanced Features</a>
                    <a href="/dashboard.html" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 px-3 py-2">Dashboard</a>
                    <a id="loginLink" href="/login.html" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 px-3 py-2">Login</a>
                    <button id="logoutBtn" class="hidden text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 px-3 py-2">Logout</button>
                    <div class="flex items-center px-3">
                        <input type="checkbox" id="toggle-theme" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="toggle-theme" class="ml-2 block text-sm text-gray-600 dark:text-gray-200">Dark Mode</label>
                    </div>
                    <a href="/donate.html" class="bg-green-500 text-white font-bold py-2 px-4 rounded-full hover:bg-green-600">♥ Support Us</a>
                    <a href="https://github.com/clogt/trappertracker" target="_blank" class="text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4">
        <!-- Alert Banner -->
        <div class="bg-yellow-50 dark:bg-yellow-900 border-l-4 border-yellow-400 p-4 mb-4">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 dark:text-yellow-200">
                        <strong>Danger Zones:</strong> Red circles indicate reported trapper activity or pet danger areas. Keep your pets safe by avoiding these locations.
                    </p>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden">
            <div id="map"></div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="/advanced.html" class="block bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg p-6 text-center transition">
                <svg class="mx-auto h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-lg font-semibold mb-1">Report a Danger Zone</h3>
                <p class="text-sm opacity-90">Alert others about trapper activity</p>
            </a>
            <a href="/advanced.html" class="block bg-blue-600 hover:bg-blue-700 text-white rounded-lg p-6 text-center transition">
                <svg class="mx-auto h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <h3 class="text-lg font-semibold mb-1">Lost & Found Pets</h3>
                <p class="text-sm opacity-90">Report or search for missing pets</p>
            </a>
            <a href="/advanced.html" class="block bg-orange-600 hover:bg-orange-700 text-white rounded-lg p-6 text-center transition">
                <svg class="mx-auto h-12 w-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <h3 class="text-lg font-semibold mb-1">All Features</h3>
                <p class="text-sm opacity-90">Access advanced map features</p>
            </a>
        </div>
    </main>

    <footer class="bg-white dark:bg-gray-800 shadow mt-8">
        <div class="container mx-auto p-4 text-center text-gray-600 dark:text-gray-400 text-sm">
            <p>&copy; 2025 TrapperTracker. Protecting pets through community awareness.</p>
        </div>
    </footer>

    <script>
        let map;
        const dangerZoneIcon = L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNCIgZmlsbD0iI2VmNDQ0NCIgc3Ryb2tlPSIjOTkxYjFiIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwiPiE8L3RleHQ+PC9zdmc+',
            iconSize: [32, 32],
            iconAnchor: [16, 16],
            popupAnchor: [0, -16]
        });

        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4); // Centered on USA

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            loadDangerZones();
        }

        async function loadDangerZones() {
            try {
                const response = await fetch('/api/reports');
                if (!response.ok) throw new Error('Failed to load reports');

                const data = await response.json();

                // Only show danger zone reports
                const dangerZones = data.filter(report => report.report_type === 'Danger Zone');

                dangerZones.forEach(report => {
                    const marker = L.marker([report.latitude, report.longitude], { icon: dangerZoneIcon })
                        .addTo(map);

                    const popupContent = `
                        <div style="min-width: 200px;">
                            <h3 style="font-weight: bold; color: #dc2626; margin-bottom: 8px;">⚠️ Danger Zone</h3>
                            <p style="margin: 4px 0;"><strong>Description:</strong> ${escapeHtml(report.description || 'No details')}</p>
                            <p style="margin: 4px 0; font-size: 0.875rem; color: #6b7280;">
                                <strong>Reported:</strong> ${new Date(report.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                });

                if (dangerZones.length === 0) {
                    console.log('No danger zones currently reported');
                }
            } catch (error) {
                console.error('Error loading danger zones:', error);
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Dark mode toggle
        const themeToggle = document.getElementById('toggle-theme');
        const applyTheme = (isDark) => {
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        const isDarkMode = savedTheme === 'dark';
        applyTheme(isDarkMode);
        if (themeToggle) {
            themeToggle.checked = isDarkMode;
            themeToggle.addEventListener('change', (event) => {
                const isDark = event.target.checked;
                applyTheme(isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        // Logout functionality
        const userRole = localStorage.getItem('userRole');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginLink = document.getElementById('loginLink');

        if (userRole) {
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            if (loginLink) loginLink.classList.add('hidden');
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('userRole');
                document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                document.cookie = 'session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.href = '/';
            });
        }

        // Initialize map on page load
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
