<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrapperTracker - Pet Safety Map</title>

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/icons/favicon.svg">
    <meta name="theme-color" content="#ef4444">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* Fixed Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #1f2937;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .menu-btn, .support-link {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            padding: 8px 12px;
            cursor: pointer;
            text-decoration: none;
        }

        .user-indicator {
            font-size: 13px;
            color: #10b981;
            padding: 6px 10px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            display: none;
        }

        .user-indicator.visible {
            display: block;
        }

        .menu-btn {
            font-size: 24px;
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            transition: right 0.3s ease;
        }

        #map.with-panel {
            right: 320px;
        }

        /* Report List Panel */
        .report-list-panel {
            position: fixed;
            top: 60px;
            right: -320px;
            width: 320px;
            bottom: 0;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            z-index: 900;
            overflow-y: auto;
            transition: right 0.3s ease;
        }

        .report-list-panel.visible {
            right: 0;
        }

        .report-list-header {
            position: sticky;
            top: 0;
            background: #1f2937;
            color: white;
            padding: 16px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .report-list-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .report-count {
            font-size: 13px;
            color: #9ca3af;
        }

        .report-list-items {
            padding: 12px;
        }

        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #ef4444;
            transform: translateX(-2px);
        }

        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .report-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .report-card-date {
            font-size: 11px;
            color: #6b7280;
        }

        .report-card-location {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .report-card-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .report-card-actions {
            display: flex;
            gap: 8px;
        }

        .report-card-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-share {
            background: #10b981;
            color: white;
        }

        .btn-share:hover {
            background: #059669;
        }

        .panel-toggle-btn {
            position: fixed;
            top: 80px;
            right: 16px;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 950;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            transition: all 0.2s;
        }

        .panel-toggle-btn:hover {
            background: #f3f4f6;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Danger Zone Toggle Button */
        .danger-zone-toggle {
            position: fixed;
            top: 140px;
            left: 16px;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 950;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .danger-zone-toggle:hover {
            background: #f3f4f6;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .danger-zone-toggle.active {
            background: #ef4444;
            color: white;
        }

        .danger-zone-toggle.active:hover {
            background: #dc2626;
        }

        .toggle-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            transition: background 0.2s;
        }

        .danger-zone-toggle:not(.active) .toggle-indicator {
            background: #9ca3af;
        }

        /* Custom Cluster Markers */
        .marker-cluster-small {
            background-color: rgba(239, 68, 68, 0.6);
        }

        .marker-cluster-small div {
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            font-weight: bold;
        }

        .marker-cluster-medium {
            background-color: rgba(239, 68, 68, 0.5);
        }

        .marker-cluster-medium div {
            background-color: rgba(239, 68, 68, 0.7);
            color: white;
            font-weight: bold;
        }

        .marker-cluster-large {
            background-color: rgba(220, 38, 38, 0.5);
        }

        .marker-cluster-large div {
            background-color: rgba(220, 38, 38, 0.7);
            color: white;
            font-weight: bold;
        }

        /* Share Modal */
        .share-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .share-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2001;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }

        .share-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        .share-modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .share-modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .share-modal-body {
            padding: 24px;
        }

        .share-report-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .share-platform-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .share-platform-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .share-platform-btn:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .share-platform-btn .btn-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .share-platform-btn .btn-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .share-platform-btn .btn-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        .facebook-btn:hover {
            border-color: #1877f2;
            background: #f0f7ff;
        }

        .nextdoor-btn:hover {
            border-color: #00b246;
            background: #f0fdf4;
        }

        .copy-btn:hover {
            border-color: #8b5cf6;
            background: #faf5ff;
        }

        .email-btn:hover {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .share-preview-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .share-preview-header {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .share-preview-content {
            background: white;
            border-radius: 6px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: #1f2937;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .report-list-panel {
                width: 100%;
                right: -100%;
            }

            .report-list-panel.visible {
                right: 0;
            }

            #map.with-panel {
                right: 0;
            }

            .panel-toggle-btn {
                right: 16px;
                top: 140px;
            }

            .share-platform-buttons {
                grid-template-columns: 1fr;
            }

            .share-modal {
                width: 95%;
                max-height: 90vh;
            }
        }

        /* Search Input Overlay - Top Right */
        .search-overlay {
            position: fixed;
            top: 76px;
            right: 16px;
            z-index: 500;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .search-overlay {
                width: 250px;
            }
        }

        /* Alert Info Panel - Right Side */
        .alert-info-panel {
            position: fixed;
            top: 130px;
            right: 16px;
            width: 320px;
            max-height: calc(100vh - 200px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 900;
            overflow-y: auto;
            display: none;
        }

        .alert-info-panel.visible {
            display: block;
        }

        .alert-info-header {
            padding: 16px;
            border-bottom: 2px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .alert-info-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-info-count {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Alert Filters Container */
        .alert-filters-container {
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Search Filter */
        .alert-search-wrapper {
            position: relative;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .alert-search-input {
            width: 100%;
            padding: 8px 32px 8px 12px;
            font-size: 13px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #f9fafb;
            transition: all 0.2s;
        }

        .alert-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .alert-search-clear {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #9ca3af;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alert-search-clear:hover {
            background: #6b7280;
        }

        /* Filter Summary */
        .filter-summary {
            padding: 8px 12px;
            background: #fef3c7;
            border-bottom: 1px solid #fde68a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        #filterSummaryText {
            color: #78350f;
            font-weight: 500;
        }

        .clear-all-filters-btn {
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-all-filters-btn:hover {
            background: #dc2626;
        }

        /* Filter Sections */
        .alert-filter-section {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .alert-filter-section:last-child {
            border-bottom: none;
        }

        .alert-filter-label {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        /* Alert Filters */
        .alert-filters {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .alert-filter-btn,
        .distance-filter-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .alert-filter-btn:hover,
        .distance-filter-btn:hover {
            background: #e5e7eb;
        }

        .alert-filter-btn.active {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .distance-filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Mobile responsive */
        @media (max-width: 640px) {
            .alert-search-input {
                font-size: 14px;
                padding: 10px 32px 10px 12px;
            }

            .alert-filter-btn,
            .distance-filter-btn {
                font-size: 11px;
                padding: 5px 10px;
            }

            .filter-summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .clear-all-filters-btn {
                width: 100%;
            }
        }

        /* Alert Statistics */
        .alert-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
            background: #fef3c7;
            border-bottom: 1px solid #fde68a;
        }

        .alert-stat-box {
            text-align: center;
        }

        .alert-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #92400e;
        }

        .alert-stat-label {
            font-size: 11px;
            color: #78350f;
            margin-top: 2px;
        }

        .alert-stat-trend {
            font-size: 10px;
            font-weight: 600;
            margin-top: 2px;
        }

        .alert-stat-trend.up {
            color: #dc2626;
        }

        .alert-stat-trend.down {
            color: #10b981;
        }

        .alert-info-content {
            padding: 12px;
        }

        .alert-info-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #9ca3af;
        }

        .alert-info-item.fresh {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .alert-info-item.recent {
            border-left-color: #f97316;
            background: #fff7ed;
        }

        .alert-info-item.old {
            border-left-color: #9ca3af;
        }

        .alert-info-item:hover {
            background: #fff;
            border-color: #ef4444;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
        }

        .alert-info-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .alert-info-item-id {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .alert-info-item-distance {
            font-size: 11px;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .alert-info-item-date {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .alert-info-item-desc {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .alert-info-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .alert-info-panel {
                display: none !important; /* Hide on mobile */
            }
        }

        /* Report Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: start;
            background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        }

        .modal-title-section {
            flex: 1;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 4px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #6b7280;
        }

        .modal-close-btn {
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .modal-close-btn:hover {
            background: #ef4444;
            color: white;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-info-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .modal-info-item {
            background: #f9fafb;
            padding: 14px;
            border-radius: 10px;
            border-left: 4px solid #ef4444;
        }

        .modal-info-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .modal-info-value {
            font-size: 15px;
            color: #111827;
            font-weight: 500;
        }

        .modal-description {
            background: #fffbeb;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #fde68a;
            margin-bottom: 24px;
        }

        .modal-description-label {
            font-size: 12px;
            font-weight: 600;
            color: #92400e;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .modal-description-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }

        .modal-map-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .modal-action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-action-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .modal-action-btn.primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .modal-action-btn.secondary {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .modal-action-btn.secondary:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .modal-action-btn.danger {
            background: #fee2e2;
            color: #dc2626;
        }

        .modal-action-btn.danger:hover {
            background: #fecaca;
        }

        @media (max-width: 768px) {
            .modal-content {
                max-height: 95vh;
            }

            .modal-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Report Button Overlay */
        .report-btn-container {
            position: fixed;
            bottom: 24px;
            left: 16px;
            right: 16px;
            z-index: 500;
        }

        .report-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse-glow 2s infinite;
        }

        .report-btn:hover {
            background: #dc2626;
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.6);
            transform: translateY(-2px);
        }

        .report-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(239, 68, 68, 0.7);
            }
        }

        /* Report Form Overlay - Left Side Panel */
        .report-overlay {
            position: fixed;
            top: 76px;
            left: 0;
            bottom: 0;
            width: 400px;
            background: white;
            border-radius: 0 12px 12px 0;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s ease, width 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .report-overlay.active {
            transform: translateX(0);
        }

        .report-overlay.expanded {
            width: 600px;
        }

        @media (max-width: 768px) {
            .report-overlay {
                width: 100%;
                top: 60px;
                border-radius: 0;
            }

            .report-overlay.expanded {
                width: 100%;
            }
        }

        .report-overlay-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .report-overlay-backdrop.active {
            opacity: 1;
            pointer-events: none; /* Don't block map clicks - let clicks pass through */
        }

        .report-form {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
            flex-shrink: 0;
        }

        .report-title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
        }

        .report-header-buttons {
            display: flex;
            gap: 8px;
        }

        .expand-btn, .close-btn {
            background: #f3f4f6;
            border: none;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .expand-btn:hover, .close-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .close-btn:hover {
            background: #ef4444;
            color: white;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #ef4444;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .report-overlay.expanded .form-textarea {
            min-height: 120px;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        /* Menu Sidebar */
        .menu-sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #1f2937;
            z-index: 3000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .menu-sidebar.active {
            left: 0;
        }

        .menu-sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-sidebar-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .menu-items {
            padding: 20px;
        }

        .menu-item {
            display: block;
            padding: 14px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .menu-item:active {
            background: #374151;
        }

        /* Loading Skeleton */
        .map-loading {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f3f4f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: opacity 0.3s ease;
        }

        .map-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .skeleton-spinner {
            width: 64px;
            height: 64px;
            border: 6px solid #e5e7eb;
            border-top-color: #ef4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton-text {
            margin-top: 24px;
            font-size: 16px;
            color: #6b7280;
            font-weight: 500;
        }

        .skeleton-subtext {
            margin-top: 8px;
            font-size: 14px;
            color: #9ca3af;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .empty-state-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .empty-state-action {
            display: inline-block;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .empty-state-action:hover {
            background: #2563eb;
        }

        /* Distance Badge */
        .distance-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
        }

        /* Report Card Enhancements */
        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #ef4444;
            transform: translateX(-2px);
        }

        /* Improved Button Touch Targets */
        .report-card-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .report-card-btn {
                min-height: 48px;
                font-size: 13px;
            }
        }

        /* Danger Zone Cluster Styling */
        .danger-zone-cluster {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.6) 70%, rgba(153, 27, 27, 0.4) 100%);
            border: 3px solid #991b1b;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 0 40px rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-danger 2s ease-in-out infinite;
        }

        .danger-zone-cluster .cluster-inner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
        }

        .danger-zone-cluster .cluster-count {
            font-size: 20px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            line-height: 1;
            margin-bottom: 2px;
        }

        .danger-zone-cluster .cluster-label {
            font-size: 8px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
        }

        /* Size variations */
        .danger-zone-cluster-small .cluster-count {
            font-size: 18px;
        }

        .danger-zone-cluster-small .cluster-label {
            font-size: 7px;
        }

        .danger-zone-cluster-medium .cluster-count {
            font-size: 24px;
        }

        .danger-zone-cluster-medium .cluster-label {
            font-size: 9px;
        }

        .danger-zone-cluster-large {
            border-width: 4px;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.7), 0 0 60px rgba(239, 68, 68, 0.4);
        }

        .danger-zone-cluster-large .cluster-count {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .danger-zone-cluster-large .cluster-label {
            font-size: 10px;
        }

        /* Pulse animation for danger zones */
        @keyframes pulse-danger {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), 0 0 40px rgba(239, 68, 68, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8), 0 0 60px rgba(239, 68, 68, 0.5);
            }
        }

        /* Override default cluster coverage polygon styling */
        .leaflet-cluster-anim .leaflet-marker-icon {
            transition: all 0.3s ease;
        }

        /* Coverage polygon for danger zones */
        path.leaflet-interactive[stroke="#03f"] {
            stroke: #dc2626 !important;
            fill: #ef4444 !important;
            fill-opacity: 0.2 !important;
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="header-title">TrapperTracker</div>
        <div class="header-right">
            <span class="user-indicator" id="userIndicator"></span>
            <a href="/login.html" class="support-link" id="loginLink">Login</a>
            <a href="/admin-login.html" class="support-link">Admin Login</a>
            <a href="/donate.html" class="support-link">Support</a>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Loading Skeleton -->
    <div class="map-loading" id="mapLoading">
        <div class="skeleton-spinner"></div>
        <div class="skeleton-text">üó∫Ô∏è Loading TrapperTracker Map...</div>
        <div class="skeleton-subtext">Fetching danger zones and pet safety data</div>
    </div>

    <!-- Trapper Alert Zones Toggle Button -->
    <button class="danger-zone-toggle active" id="dangerZoneToggle">
        <span class="toggle-indicator"></span>
        <span>üö® Trapper Alert Zones</span>
    </button>

    <!-- Search Input Overlay -->
    <div class="search-overlay">
        <input type="text" class="search-input" id="locationSearch" placeholder="Search location...">
    </div>

    <!-- Alert Info Panel -->
    <div class="alert-info-panel" id="alertInfoPanel">
        <div class="alert-info-header">
            <div class="alert-info-title">
                üö® Alerts in View
            </div>
            <div class="alert-info-count" id="alertInfoCount">0 trapper alerts</div>
        </div>

        <!-- Alert Filters -->
        <div class="alert-filters-container">
            <!-- Search Filter -->
            <div class="alert-search-wrapper">
                <input type="text" id="alertSearchInput" class="alert-search-input" placeholder="Search alerts...">
                <button id="clearSearchBtn" class="alert-search-clear hidden">√ó</button>
            </div>

            <!-- Filter Summary & Clear All -->
            <div id="filterSummary" class="filter-summary hidden">
                <span id="filterSummaryText"></span>
                <button id="clearAllFiltersBtn" class="clear-all-filters-btn">Clear all filters</button>
            </div>

            <!-- Time Filters -->
            <div class="alert-filter-section">
                <div class="alert-filter-label">Time:</div>
                <div class="alert-filters">
                    <button class="alert-filter-btn active" data-filter="all">All Time</button>
                    <button class="alert-filter-btn" data-filter="today">Today</button>
                    <button class="alert-filter-btn" data-filter="week">This Week</button>
                    <button class="alert-filter-btn" data-filter="month">This Month</button>
                </div>
            </div>

            <!-- Distance Filters (shown only when user location is available) -->
            <div id="distanceFilterSection" class="alert-filter-section hidden">
                <div class="alert-filter-label">Distance:</div>
                <div class="alert-filters">
                    <button class="distance-filter-btn active" data-distance="all">All distances</button>
                    <button class="distance-filter-btn" data-distance="1">Within 1mi</button>
                    <button class="distance-filter-btn" data-distance="5">Within 5mi</button>
                    <button class="distance-filter-btn" data-distance="10">Within 10mi</button>
                </div>
            </div>
        </div>

        <!-- Alert Statistics -->
        <div class="alert-stats" id="alertStats">
            <div class="alert-stat-box">
                <div class="alert-stat-value" id="stat24h">0</div>
                <div class="alert-stat-label">Last 24 Hours</div>
            </div>
            <div class="alert-stat-box">
                <div class="alert-stat-value" id="statWeek">0</div>
                <div class="alert-stat-label">This Week</div>
                <div class="alert-stat-trend" id="weekTrend"></div>
            </div>
        </div>

        <div class="alert-info-content" id="alertInfoContent">
            <!-- Alert items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title-section">
                    <div class="modal-title" id="modalTitle">Alert Details</div>
                    <div class="modal-subtitle" id="modalSubtitle">Trapper Activity Report</div>
                </div>
                <button class="modal-close-btn" id="modalCloseBtn">√ó</button>
            </div>

            <div class="modal-body">
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-label">Report ID</div>
                        <div class="modal-info-value" id="modalReportId">#0000</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Reported</div>
                        <div class="modal-info-value" id="modalReportDate">Unknown</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label">Location</div>
                        <div class="modal-info-value" id="modalLocation">Loading...</div>
                    </div>
                    <div class="modal-info-item" id="modalDistanceItem" style="display: none;">
                        <div class="modal-info-label">Distance from You</div>
                        <div class="modal-info-value" id="modalDistance">-</div>
                    </div>
                </div>

                <div class="modal-description" id="modalDescriptionBox">
                    <div class="modal-description-label">Description</div>
                    <div class="modal-description-text" id="modalDescription">
                        No description provided.
                    </div>
                </div>

                <div class="modal-map-preview" id="modalMapPreview"></div>
            </div>

            <div class="modal-actions">
                <button class="modal-action-btn primary" id="modalDirections">
                    üß≠ Get Directions
                </button>
                <button class="modal-action-btn secondary" id="modalShare">
                    üîó Share Alert
                </button>
                <button class="modal-action-btn secondary" id="modalCenterMap">
                    üìç Center Map
                </button>
                <button class="modal-action-btn danger" id="modalFlag">
                    üö© Flag Report
                </button>
            </div>
        </div>
    </div>

    <!-- Report Button Overlay -->
    <div class="report-btn-container">
        <button class="report-btn" id="reportBtn">üö® Report Trapper Activity</button>
    </div>

    <!-- Report Form Overlay -->
    <div class="report-overlay-backdrop" id="reportBackdrop"></div>
    <div class="report-overlay" id="reportOverlay">
        <!-- Auth Form (Login/Register) -->
        <form class="report-form" id="authForm" style="display: none;">
            <div class="report-header">
                <h2 class="report-title" id="authTitle">Login to Report</h2>
                <div class="report-header-buttons">
                    <button type="button" class="expand-btn" id="expandBtn" title="Expand panel">‚õ∂</button>
                    <button type="button" class="close-btn" id="closeBtn">√ó</button>
                </div>
            </div>

            <div id="authMessage" class="message"></div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="authEmail" required>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="authPassword" required minlength="8">
                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;" id="passwordHint">Min 8 characters, 1 uppercase, 1 lowercase, 1 number, 1 special character</p>
            </div>

            <div class="form-group" id="confirmPasswordGroup" style="display: none;">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="authPasswordConfirm" minlength="8">
            </div>

            <!-- Turnstile CAPTCHA -->
            <div class="form-group">
                <div class="cf-turnstile" id="auth-turnstile" data-sitekey="0x4AAAAAAB_w9INZSbixJ5Nk" data-theme="light"></div>
            </div>

            <button type="submit" class="submit-btn" id="authSubmitBtn">Login</button>

            <p style="text-align: center; margin-top: 16px; font-size: 14px; color: #6b7280;">
                <span id="authToggleText">Don't have an account?</span>
                <button type="button" id="authToggleBtn" style="background: none; border: none; color: #3b82f6; text-decoration: underline; cursor: pointer;">Register</button>
            </p>
        </form>

        <!-- Report Form -->
        <form class="report-form" id="reportForm" style="display: none;">
            <div class="report-header">
                <h2 class="report-title">Report Trapper Activity</h2>
                <div class="report-header-buttons">
                    <button type="button" class="expand-btn" id="expandBtnReport" title="Expand panel">‚õ∂</button>
                    <button type="button" class="close-btn" id="closeBtnReport">√ó</button>
                </div>
            </div>

            <div id="reportMessage" class="message"></div>

            <!-- Location Instructions -->
            <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 16px; border-radius: 4px;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">üìç How to set location:</div>
                <div style="font-size: 13px; color: #1e3a8a;">
                    Click anywhere on the map behind this form to mark the trapper location. A green marker will appear.
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Report Type</label>
                <select class="form-select" id="reportType" required>
                    <option value="dangerZone">Danger Zone</option>
                    <option value="lostPet">Lost Pet</option>
                    <option value="foundPet">Found Pet</option>
                    <option value="dangerousAnimal">Dangerous Animal</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Location Coordinates</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="reportLocation" readonly required placeholder="Click map or use GPS button" style="flex: 1;">
                    <button type="button" id="useCurrentLocationBtn" style="padding: 12px 16px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">üìç Use GPS</button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Street Address <span style="font-size: 12px; color: #6b7280; font-weight: normal;">(Optional)</span></label>
                <input type="text" class="form-input" id="reportStreet" placeholder="e.g., 123 Main St">
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" id="reportCity" placeholder="City name">
                </div>
                <div class="form-group">
                    <label class="form-label">State</label>
                    <input type="text" class="form-input" id="reportState" placeholder="ST" maxlength="2" style="text-transform: uppercase;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="reportDescription" placeholder="Describe the trapper activity or suspicious behavior..." required></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Submit Report</button>
        </form>
    </div>

    <!-- Menu Sidebar -->
    <div class="menu-sidebar-backdrop" id="menuBackdrop"></div>
    <div class="menu-sidebar" id="menuSidebar">
        <div class="menu-items">
            <a href="/" class="menu-item">üè† Home</a>
            <a href="/donate.html" class="menu-item">‚ô•Ô∏è Support Us</a>
        </div>
    </div>

    <!-- Report List Panel Toggle Button -->
    <button class="panel-toggle-btn" id="panelToggleBtn" style="display: none;">
        üìã Reports (<span id="reportCountBadge">0</span>)
    </button>

    <!-- Report List Panel -->
    <div class="report-list-panel" id="reportListPanel">
        <div class="report-list-header">
            <div class="report-list-title">üö® Active Trapper Alerts</div>
            <div class="report-count"><span id="panelReportCount">0</span> reports in this area</div>
        </div>
        <div class="report-list-items" id="reportListItems">
            <!-- Report cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Social Share Modal -->
    <div class="share-modal-backdrop" id="shareModalBackdrop" style="display: none;"></div>
    <div class="share-modal" id="shareModal" style="display: none;">
        <div class="share-modal-header">
            <h2 class="share-modal-title">üì§ Share Trapper Alert</h2>
            <button class="share-modal-close" id="shareModalClose">√ó</button>
        </div>

        <div class="share-modal-body">
            <div class="share-report-preview" id="shareReportPreview">
                <!-- Report preview will be inserted here -->
            </div>

            <div class="share-platform-buttons">
                <button class="share-platform-btn facebook-btn" id="shareFacebook">
                    <span class="btn-icon">üìò</span>
                    <div>
                        <div class="btn-title">Facebook</div>
                        <div class="btn-subtitle">Group & Timeline optimized</div>
                    </div>
                </button>

                <button class="share-platform-btn nextdoor-btn" id="shareNextdoor">
                    <span class="btn-icon">üèòÔ∏è</span>
                    <div>
                        <div class="btn-title">Nextdoor</div>
                        <div class="btn-subtitle">Neighborhood format</div>
                    </div>
                </button>

                <button class="share-platform-btn copy-btn" id="shareCopyLink">
                    <span class="btn-icon">üîó</span>
                    <div>
                        <div class="btn-title">Copy Link</div>
                        <div class="btn-subtitle">Share anywhere</div>
                    </div>
                </button>

                <button class="share-platform-btn email-btn" id="shareEmail">
                    <span class="btn-icon">üìß</span>
                    <div>
                        <div class="btn-title">Email</div>
                        <div class="btn-subtitle">Send to friends</div>
                    </div>
                </button>
            </div>

            <div class="share-preview-section">
                <div class="share-preview-header">Preview:</div>
                <div class="share-preview-content" id="sharePreviewContent">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">Select a platform to preview the message</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let userMarker;
        let userLat, userLng;
        let clickedLat, clickedLng; // Coordinates from map click
        let markerClusterGroup;
        let dangerZoneCircles = L.layerGroup(); // Layer group for danger zone circles
        let allDangerZones = [];
        let isPanelVisible = false;
        let showDangerZones = true; // Toggle for showing/hiding danger zones
        let currentAlertFilter = 'all'; // Current time filter for alerts
        let currentDistanceFilter = 'all'; // Current distance filter (all, 1, 5, 10)
        let currentSearchKeyword = ''; // Current search keyword
        let allVisibleReports = []; // Store all reports in current view for filtering

        // Check and display logged-in user
        async function checkLoggedInUser() {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });

                const loginLink = document.getElementById('loginLink');

                if (response.ok) {
                    const data = await response.json();
                    const userIndicator = document.getElementById('userIndicator');
                    if (data.email) {
                        userIndicator.textContent = `üë§ ${data.email}`;
                        userIndicator.classList.add('visible');
                        // Hide login link when user is logged in
                        if (loginLink) loginLink.style.display = 'none';
                    }
                } else {
                    // Show login link when user is not logged in
                    if (loginLink) loginLink.style.display = '';
                }
            } catch (error) {
                console.log('User not logged in');
                // Show login link on error
                const loginLink = document.getElementById('loginLink');
                if (loginLink) loginLink.style.display = '';
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: false
            }).setView([39.8283, -98.5795], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Add zoom control to bottom right
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Initialize marker cluster group with danger zone styling
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 120, // Larger radius to group nearby trapper zones
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: true, // Show danger zone coverage area on hover
                zoomToBoundsOnClick: true,
                spiderfyDistanceMultiplier: 1.5,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    let iconSize = 50;

                    // Create larger clusters for dense trapper zones
                    if (count >= 20) {
                        size = 'large';
                        iconSize = 80;
                    } else if (count >= 10) {
                        size = 'medium';
                        iconSize = 65;
                    }

                    return L.divIcon({
                        html: `<div class="cluster-inner"><span class="cluster-count">${count}</span><span class="cluster-label">DANGER ZONES</span></div>`,
                        className: `danger-zone-cluster danger-zone-cluster-${size}`,
                        iconSize: L.point(iconSize, iconSize)
                    });
                }
            });

            map.addLayer(markerClusterGroup);

            // Add danger zone circles layer (below markers)
            dangerZoneCircles.addTo(map);

            // Listen for map movements to update report list
            map.on('zoomend moveend', updateReportList);

            // Hide loading skeleton when map is ready
            map.whenReady(() => {
                setTimeout(() => {
                    document.getElementById('mapLoading').classList.add('hidden');
                }, 500);
            });

            // Request user location
            requestUserLocation();

            // Load danger zones
            loadDangerZones();

            // Setup panel toggle button
            setupPanelToggle();

            // Setup click-to-report on map
            setupMapClickReport();
        }

        // Setup map click for reporting
        let clickReportMarker = null;
        function setupMapClickReport() {
            map.on('click', async (e) => {
                // Only activate if report overlay is open (either auth or report form)
                const reportOverlay = document.getElementById('reportOverlay');

                if (!reportOverlay.classList.contains('active')) {
                    return; // Don't capture clicks when overlay isn't open
                }

                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                // Store clicked coordinates
                clickedLat = lat;
                clickedLng = lng;

                // Update form coordinates
                document.getElementById('reportLocation').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                console.log('Map clicked:', lat, lng); // Debug log

                // Remove previous click marker if exists
                if (clickReportMarker) {
                    map.removeLayer(clickReportMarker);
                }

                // Add temporary marker at clicked location
                clickReportMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMCIgZmlsbD0iIzEwYjk4MSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(map);

                clickReportMarker.bindPopup('üìç Report location').openPopup();

                // Reverse geocode to get address
                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                        { headers: { 'User-Agent': 'TrapperTracker/1.0' } }
                    );

                    const data = await response.json();
                    if (data && data.address) {
                        // Populate address fields
                        const addr = data.address;

                        const street = [addr.house_number, addr.road].filter(Boolean).join(' ');
                        if (street) document.getElementById('reportStreet').value = street;

                        if (addr.city || addr.town || addr.village) {
                            document.getElementById('reportCity').value = addr.city || addr.town || addr.village;
                        }

                        if (addr.state) {
                            // Try to get state abbreviation
                            const stateAbbrev = getStateAbbreviation(addr.state);
                            document.getElementById('reportState').value = stateAbbrev;
                        }
                    }
                } catch (error) {
                    console.error('Reverse geocoding error:', error);
                    // Silent fail - coordinates are already set
                }
            });
        }

        // State name to abbreviation mapping
        function getStateAbbreviation(stateName) {
            const states = {
                'alabama': 'AL', 'alaska': 'AK', 'arizona': 'AZ', 'arkansas': 'AR',
                'california': 'CA', 'colorado': 'CO', 'connecticut': 'CT', 'delaware': 'DE',
                'florida': 'FL', 'georgia': 'GA', 'hawaii': 'HI', 'idaho': 'ID',
                'illinois': 'IL', 'indiana': 'IN', 'iowa': 'IA', 'kansas': 'KS',
                'kentucky': 'KY', 'louisiana': 'LA', 'maine': 'ME', 'maryland': 'MD',
                'massachusetts': 'MA', 'michigan': 'MI', 'minnesota': 'MN', 'mississippi': 'MS',
                'missouri': 'MO', 'montana': 'MT', 'nebraska': 'NE', 'nevada': 'NV',
                'new hampshire': 'NH', 'new jersey': 'NJ', 'new mexico': 'NM', 'new york': 'NY',
                'north carolina': 'NC', 'north dakota': 'ND', 'ohio': 'OH', 'oklahoma': 'OK',
                'oregon': 'OR', 'pennsylvania': 'PA', 'rhode island': 'RI', 'south carolina': 'SC',
                'south dakota': 'SD', 'tennessee': 'TN', 'texas': 'TX', 'utah': 'UT',
                'vermont': 'VT', 'virginia': 'VA', 'washington': 'WA', 'west virginia': 'WV',
                'wisconsin': 'WI', 'wyoming': 'WY'
            };

            const lower = stateName.toLowerCase();
            return states[lower] || stateName.toUpperCase().substring(0, 2);
        }

        // Request user's location
        function requestUserLocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;

                        // Center map on user
                        map.setView([userLat, userLng], 13);

                        // Add user marker
                        userMarker = L.marker([userLat, userLng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMCIgZmlsbD0iIzM4OTVmZiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);

                        userMarker.bindPopup('Your Location');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    }
                );
            }
        }

        // Load danger zones with clustering
        async function loadDangerZones() {
            try {
                const response = await fetch('/api/reports');
                if (!response.ok) {
                    console.error('Failed to fetch reports:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('Loaded reports from API:', data.length);

                allDangerZones = data.filter(r => r.report_type === 'Danger Zone');
                console.log('Filtered danger zones:', allDangerZones.length);

                // Clear existing markers and circles
                markerClusterGroup.clearLayers();
                dangerZoneCircles.clearLayers();

                // Add markers and danger zone circles
                allDangerZones.forEach(report => {
                    // Create danger zone circle (599 sq ft diameter = ~300 ft radius)
                    // Convert feet to meters: 300 ft * 0.3048 = 91.44 meters
                    const circle = L.circle([report.latitude, report.longitude], {
                        radius: 91.44, // ~300 feet in meters
                        color: '#dc2626', // Darker red border
                        fillColor: '#ef4444', // Red fill
                        fillOpacity: 0.15, // Semi-transparent
                        weight: 2,
                        opacity: 0.5
                    });

                    // Add popup to circle as well
                    const popupContent = `
                        <div style="max-width: 200px;">
                            <b>üö® Trapper Alert Zone</b><br>
                            <small>${formatDate(report.report_timestamp)}</small><br>
                            ${report.description || 'No details'}<br>
                            <span style="font-size: 11px; color: #6b7280; margin-top: 4px; display: block;">‚ö†Ô∏è Keep pets away - ~300 ft alert radius</span>
                        </div>
                    `;
                    circle.bindPopup(popupContent);

                    // Add circle to layer group
                    dangerZoneCircles.addLayer(circle);

                    // Create marker
                    const marker = L.marker([report.latitude, report.longitude], {
                        icon: L.icon({
                            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNCIgZmlsbD0iI2VmNDQ0NCIgc3Ryb2tlPSIjOTkxYjFiIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIj4hPC90ZXh0Pjwvc3ZnPg==',
                            iconSize: [32, 32]
                        })
                    });

                    // Store report data in marker for later access
                    marker.reportData = report;

                    // Create popup content for marker
                    marker.bindPopup(popupContent);

                    markerClusterGroup.addLayer(marker);
                });

                console.log('Added', allDangerZones.length, 'markers to cluster group');
                console.log('Total layers in cluster group:', markerClusterGroup.getLayers().length);

                // If geolocation hasn't positioned the map yet and we have markers, fit bounds to show all markers
                if (allDangerZones.length > 0 && !userMarker) {
                    setTimeout(() => {
                        if (!userMarker && markerClusterGroup.getLayers().length > 0) {
                            const bounds = markerClusterGroup.getBounds();
                            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                            console.log('Fitted map to show all markers');
                        }
                    }, 1000);
                }

                // Update report list after loading
                updateReportList();

            } catch (error) {
                console.error('Error loading danger zones:', error);
            }
        }

        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = new Date(timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString();
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Format distance for display
        function formatDistance(miles) {
            if (miles < 0.1) return 'Very close';
            if (miles < 1) return `${(miles * 5280).toFixed(0)} ft`;
            if (miles < 10) return `${miles.toFixed(1)} mi`;
            return `${miles.toFixed(0)} mi`;
        }

        // Update report list based on visible map area
        function updateReportList() {
            const zoom = map.getZoom();
            const bounds = map.getBounds();

            // Get reports visible in current bounds
            const visibleReports = allDangerZones.filter(report => {
                return bounds.contains([report.latitude, report.longitude]);
            });

            const reportCount = visibleReports.length;

            // Show panel if conditions met: zoom >= 13 AND 10+ reports
            const shouldShowPanel = zoom >= 13 && reportCount >= 10;

            // Update toggle button
            const toggleBtn = document.getElementById('panelToggleBtn');
            const reportCountBadge = document.getElementById('reportCountBadge');

            if (shouldShowPanel) {
                toggleBtn.style.display = 'block';
                reportCountBadge.textContent = reportCount;
            } else {
                toggleBtn.style.display = 'none';
                // Hide panel if conditions no longer met
                if (isPanelVisible) {
                    toggleReportPanel();
                }
            }

            // If panel is visible, update its content
            if (isPanelVisible) {
                renderReportList(visibleReports);
            }

            // Update alert info panel (always show when zoomed in at level 10+)
            updateAlertInfoPanel(visibleReports, zoom);
        }

        // Update Alert Info Panel
        // Filter reports by timeframe
        function filterReportsByTime(reports, filter) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthStart = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            return reports.filter(report => {
                const reportDate = new Date(report.report_timestamp);
                switch(filter) {
                    case 'today':
                        return reportDate >= todayStart;
                    case 'week':
                        return reportDate >= weekStart;
                    case 'month':
                        return reportDate >= monthStart;
                    default:
                        return true; // 'all'
                }
            });
        }

        // Filter reports by distance radius
        function filterReportsByDistance(reports, distanceLimit) {
            if (distanceLimit === 'all' || !userLat || !userLng) {
                return reports;
            }

            const maxDistance = parseFloat(distanceLimit);
            return reports.filter(report => {
                const distance = calculateDistance(userLat, userLng, report.latitude, report.longitude);
                return distance <= maxDistance;
            });
        }

        // Filter reports by keyword search
        function filterReportsByKeyword(reports, keyword) {
            if (!keyword || keyword.trim() === '') {
                return reports;
            }

            const searchTerm = keyword.toLowerCase().trim();
            return reports.filter(report => {
                const description = (report.description || '').toLowerCase();
                const reportId = `#${report.report_id}`.toLowerCase();
                return description.includes(searchTerm) || reportId.includes(searchTerm);
            });
        }

        // Apply all active filters
        function applyAllFilters(reports) {
            let filtered = reports;

            // Apply time filter
            filtered = filterReportsByTime(filtered, currentAlertFilter);

            // Apply distance filter
            filtered = filterReportsByDistance(filtered, currentDistanceFilter);

            // Apply search filter
            filtered = filterReportsByKeyword(filtered, currentSearchKeyword);

            return filtered;
        }

        // Update filter summary
        function updateFilterSummary(totalReports, filteredReports) {
            const summaryDiv = document.getElementById('filterSummary');
            const summaryText = document.getElementById('filterSummaryText');

            const activeFilters = [];
            if (currentAlertFilter !== 'all') activeFilters.push('time');
            if (currentDistanceFilter !== 'all' && userLat && userLng) activeFilters.push('distance');
            if (currentSearchKeyword !== '') activeFilters.push('search');

            if (activeFilters.length > 0) {
                summaryDiv.classList.remove('hidden');
                summaryText.textContent = `Showing ${filteredReports.length} of ${totalReports} alerts`;
            } else {
                summaryDiv.classList.add('hidden');
            }
        }

        // Save filter preferences to localStorage
        function saveFilterPreferences() {
            try {
                const preferences = {
                    timeFilter: currentAlertFilter,
                    distanceFilter: currentDistanceFilter,
                    searchKeyword: currentSearchKeyword
                };
                localStorage.setItem('alertFilterPreferences', JSON.stringify(preferences));
            } catch (error) {
                console.error('Failed to save filter preferences:', error);
            }
        }

        // Load filter preferences from localStorage
        function loadFilterPreferences() {
            try {
                const saved = localStorage.getItem('alertFilterPreferences');
                if (saved) {
                    const preferences = JSON.parse(saved);

                    // Restore time filter
                    if (preferences.timeFilter) {
                        currentAlertFilter = preferences.timeFilter;
                        document.querySelectorAll('.alert-filter-btn').forEach(b => b.classList.remove('active'));
                        const btn = document.querySelector(`.alert-filter-btn[data-filter="${preferences.timeFilter}"]`);
                        if (btn) btn.classList.add('active');
                    }

                    // Restore distance filter
                    if (preferences.distanceFilter) {
                        currentDistanceFilter = preferences.distanceFilter;
                        document.querySelectorAll('.distance-filter-btn').forEach(b => b.classList.remove('active'));
                        const btn = document.querySelector(`.distance-filter-btn[data-distance="${preferences.distanceFilter}"]`);
                        if (btn) btn.classList.add('active');
                    }

                    // Restore search keyword
                    if (preferences.searchKeyword) {
                        currentSearchKeyword = preferences.searchKeyword;
                        const searchInput = document.getElementById('alertSearchInput');
                        const clearSearchBtn = document.getElementById('clearSearchBtn');
                        if (searchInput) {
                            searchInput.value = preferences.searchKeyword;
                            clearSearchBtn.classList.remove('hidden');
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load filter preferences:', error);
            }
        }

        // Get alert age class
        function getAlertAgeClass(timestamp) {
            const now = new Date();
            const reportDate = new Date(timestamp);
            const hoursDiff = (now - reportDate) / (1000 * 60 * 60);

            if (hoursDiff <= 24) return 'fresh';
            if (hoursDiff <= 168) return 'recent'; // 7 days
            return 'old';
        }

        // Global variable to store current modal report
        let currentModalReport = null;

        // Show report detail modal
        async function showReportModal(report) {
            currentModalReport = report;
            const modal = document.getElementById('reportModal');

            // Update modal content
            document.getElementById('modalReportId').textContent = `#${report.blip_id || 'unknown'}`;
            document.getElementById('modalReportDate').textContent = formatDate(report.report_timestamp);
            document.getElementById('modalDescription').textContent = report.description || 'No description provided.';

            // Show distance if user location available
            const distanceItem = document.getElementById('modalDistanceItem');
            if (userLat && userLng) {
                const distance = calculateDistance(userLat, userLng, report.latitude, report.longitude);
                document.getElementById('modalDistance').textContent = formatDistance(distance);
                distanceItem.style.display = 'block';
            } else {
                distanceItem.style.display = 'none';
            }

            // Get reverse geocoded location
            document.getElementById('modalLocation').textContent = 'Loading location...';
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${report.latitude}&lon=${report.longitude}`);
                const data = await response.json();
                const address = data.address;
                const locationText = address.road
                    ? `${address.road}, ${address.city || address.town || address.village || 'Unknown'}`
                    : `${address.city || address.town || address.village || 'Unknown location'}`;
                document.getElementById('modalLocation').textContent = locationText;
            } catch (err) {
                document.getElementById('modalLocation').textContent = `${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}`;
            }

            // Create mini map preview
            const mapPreview = document.getElementById('modalMapPreview');
            mapPreview.innerHTML = '';
            const miniMap = L.map(mapPreview, {
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false
            }).setView([report.latitude, report.longitude], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(miniMap);

            // Add marker
            L.marker([report.latitude, report.longitude], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="width: 20px; height: 20px; background: #ef4444; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20]
                })
            }).addTo(miniMap);

            // Add danger circle
            L.circle([report.latitude, report.longitude], {
                color: '#ef4444',
                fillColor: '#ef4444',
                fillOpacity: 0.15,
                radius: 91.44 // 300 feet in meters
            }).addTo(miniMap);

            // Show modal
            modal.classList.add('visible');
        }

        // Close modal
        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            modal.classList.remove('visible');
            currentModalReport = null;
        }

        // Modal action: Get directions
        function getDirectionsToReport() {
            if (!currentModalReport) return;
            const lat = currentModalReport.latitude;
            const lng = currentModalReport.longitude;

            // Open Google Maps directions
            if (userLat && userLng) {
                window.open(`https://www.google.com/maps/dir/${userLat},${userLng}/${lat},${lng}`, '_blank');
            } else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, '_blank');
            }
        }

        // Modal action: Share alert
        function shareAlert() {
            if (!currentModalReport) return;
            const url = `${window.location.origin}/?report=${currentModalReport.report_id}&lat=${currentModalReport.latitude}&lng=${currentModalReport.longitude}`;

            if (navigator.share) {
                navigator.share({
                    title: 'TrapperTracker Alert',
                    text: `Trapper activity reported near this location - Alert #${currentModalReport.report_id}`,
                    url: url
                }).catch(err => console.log('Share failed', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    alert('Alert link copied to clipboard!');
                }).catch(err => {
                    prompt('Copy this link:', url);
                });
            }
        }

        // Modal action: Center map on report
        function centerMapOnReportFromModal() {
            if (!currentModalReport) return;
            map.setView([currentModalReport.latitude, currentModalReport.longitude], 16);
            closeReportModal();
        }

        // Modal action: Flag report
        function flagReport() {
            if (!currentModalReport) return;
            if (confirm(`Are you sure you want to flag Alert #${currentModalReport.report_id} as inappropriate or inaccurate?`)) {
                // TODO: Implement flag report API
                alert('Thank you for flagging this report. Our team will review it.');
                closeReportModal();
            }
        }

        function updateAlertInfoPanel(reports, zoom) {
            const panel = document.getElementById('alertInfoPanel');
            const content = document.getElementById('alertInfoContent');
            const countEl = document.getElementById('alertInfoCount');

            // Show/hide distance filter section based on user location
            const distanceSection = document.getElementById('distanceFilterSection');
            if (userLat && userLng) {
                distanceSection.classList.remove('hidden');
            } else {
                distanceSection.classList.add('hidden');
            }

            // Show panel if zoomed in enough and have reports
            if (zoom >= 10 && reports.length > 0) {
                panel.classList.add('visible');

                // Store all visible reports for filtering
                allVisibleReports = reports;

                // Apply all filters (time + distance + search)
                const filteredReports = applyAllFilters(reports);

                // Update filter summary
                updateFilterSummary(reports.length, filteredReports.length);

                // Update count
                countEl.textContent = `${filteredReports.length} trapper alert${filteredReports.length !== 1 ? 's' : ''}`;

                // Calculate statistics
                const now = new Date();
                const last24h = filteredReports.filter(r => {
                    const diff = now - new Date(r.report_timestamp);
                    return diff <= 24 * 60 * 60 * 1000;
                }).length;

                const last7d = filteredReports.filter(r => {
                    const diff = now - new Date(r.report_timestamp);
                    return diff <= 7 * 24 * 60 * 60 * 1000;
                }).length;

                const prev7d = filteredReports.filter(r => {
                    const diff = now - new Date(r.report_timestamp);
                    return diff > 7 * 24 * 60 * 60 * 1000 && diff <= 14 * 24 * 60 * 60 * 1000;
                }).length;

                // Update stats
                document.getElementById('stat24h').textContent = last24h;
                document.getElementById('statWeek').textContent = last7d;

                const trendEl = document.getElementById('weekTrend');
                if (prev7d > 0) {
                    const change = last7d - prev7d;
                    const pct = Math.round((change / prev7d) * 100);
                    if (pct > 0) {
                        trendEl.textContent = `‚ñ≤ ${pct}% vs last week`;
                        trendEl.className = 'alert-stat-trend up';
                    } else if (pct < 0) {
                        trendEl.textContent = `‚ñº ${Math.abs(pct)}% vs last week`;
                        trendEl.className = 'alert-stat-trend down';
                    } else {
                        trendEl.textContent = 'No change';
                        trendEl.className = 'alert-stat-trend';
                    }
                } else {
                    trendEl.textContent = '';
                }

                // Sort by distance if user location available, otherwise by date
                let sortedReports = [...filteredReports];
                if (userLat && userLng) {
                    sortedReports.sort((a, b) => {
                        const distA = calculateDistance(userLat, userLng, a.latitude, a.longitude);
                        const distB = calculateDistance(userLat, userLng, b.latitude, b.longitude);
                        return distA - distB;
                    });
                } else {
                    sortedReports.sort((a, b) => {
                        return new Date(b.report_timestamp) - new Date(a.report_timestamp);
                    });
                }

                // Render alert items
                content.innerHTML = sortedReports.slice(0, 20).map((report, index) => {
                    let distanceHTML = '';
                    if (userLat && userLng) {
                        const distance = calculateDistance(userLat, userLng, report.latitude, report.longitude);
                        distanceHTML = `<span class="alert-info-item-distance">${formatDistance(distance)}</span>`;
                    }

                    const ageClass = getAlertAgeClass(report.report_timestamp);

                    return `
                        <div class="alert-info-item ${ageClass}" data-report-index="${index}">
                            <div class="alert-info-item-header">
                                <span class="alert-info-item-id">Alert #${report.report_id}</span>
                                ${distanceHTML}
                            </div>
                            <div class="alert-info-item-date">${formatDate(report.report_timestamp)}</div>
                            <div class="alert-info-item-desc">${report.description || 'Trapper activity reported in this area'}</div>
                        </div>
                    `;
                }).join('');

                // Add click handlers to alert items
                document.querySelectorAll('.alert-info-item').forEach((item, index) => {
                    item.addEventListener('click', () => {
                        showReportModal(sortedReports[index]);
                    });
                });

                if (sortedReports.length > 20) {
                    content.innerHTML += `
                        <div style="text-align: center; padding: 12px; color: #6b7280; font-size: 12px;">
                            Showing 20 of ${sortedReports.length} alerts
                        </div>
                    `;
                }
            } else {
                panel.classList.remove('visible');
            }
        }

        // Render report cards in the panel
        function renderReportList(reports) {
            const panelReportCount = document.getElementById('panelReportCount');
            const reportListItems = document.getElementById('reportListItems');

            panelReportCount.textContent = reports.length;

            if (reports.length === 0) {
                reportListItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üêæ</div>
                        <div class="empty-state-title">No Trapper Alerts Here</div>
                        <div class="empty-state-description">
                            Great news! No pet trapper activity has been reported in this area recently.
                            Zoom out to see more reports or help keep pets safe by reporting any suspicious trapper activity.
                        </div>
                        <button class="empty-state-action" onclick="document.getElementById('reportBtn').click()">
                            üö® Report Trapper Activity
                        </button>
                    </div>
                `;
                return;
            }

            // Sort by most recent first
            const sortedReports = [...reports].sort((a, b) => {
                return new Date(b.report_timestamp) - new Date(a.report_timestamp);
            });

            // Limit to 50 reports to prevent performance issues
            const displayReports = sortedReports.slice(0, 50);

            reportListItems.innerHTML = displayReports.map((report, index) => {
                // Calculate distance if user location is available
                let distanceBadge = '';
                if (userLat && userLng) {
                    const distance = calculateDistance(userLat, userLng, report.latitude, report.longitude);
                    distanceBadge = `<span class="distance-badge">${formatDistance(distance)}</span>`;
                }

                return `
                    <div class="report-card" data-report-id="${report.report_id}" data-lat="${report.latitude}" data-lng="${report.longitude}">
                        <div class="report-card-header">
                            <div class="report-card-title">Report #${report.report_id}${distanceBadge}</div>
                            <div class="report-card-date">${formatDate(report.report_timestamp)}</div>
                        </div>
                        <div class="report-card-location">
                            üìç ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
                        </div>
                        <div class="report-card-description">
                            ${report.description || 'No description provided'}
                        </div>
                        <div class="report-card-actions">
                            <button class="report-card-btn btn-view" onclick="centerMapOnReport(${report.latitude}, ${report.longitude})">
                                üìç View
                            </button>
                            <button class="report-card-btn btn-share" onclick="shareReport(${report.report_id})">
                                üì§ Share
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            if (reports.length > 50) {
                reportListItems.innerHTML += `
                    <div style="padding: 16px; text-align: center; color: #6b7280; font-size: 12px;">
                        Showing 50 of ${reports.length} reports. Zoom in for more detail.
                    </div>
                `;
            }
        }

        // Center map on specific report
        function centerMapOnReport(lat, lng) {
            map.setView([lat, lng], 16, { animate: true });
        }

        // Share report - open modal with sharing options
        let currentShareReport = null;

        function shareReport(reportId) {
            // Find the report data
            const report = allDangerZones.find(r => r.report_id === reportId);
            if (!report) {
                console.error('Report not found:', reportId);
                return;
            }

            currentShareReport = report;

            // Show modal
            document.getElementById('shareModalBackdrop').style.display = 'block';
            document.getElementById('shareModal').style.display = 'block';

            // Populate report preview
            const previewEl = document.getElementById('shareReportPreview');
            previewEl.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">Report #${report.report_id}</div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                    üìç ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
                </div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                    üìÖ ${formatDate(report.report_timestamp)}
                </div>
                <div style="font-size: 14px; color: #1f2937;">
                    ${report.description || 'No description provided'}
                </div>
            `;

            // Setup share button handlers
            setupShareHandlers();
        }

        // Setup share modal handlers
        function setupShareHandlers() {
            const modal = document.getElementById('shareModal');
            const backdrop = document.getElementById('shareModalBackdrop');
            const closeBtn = document.getElementById('shareModalClose');
            const previewContent = document.getElementById('sharePreviewContent');

            // Close modal
            const closeModal = () => {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
                currentShareReport = null;
            };

            closeBtn.onclick = closeModal;
            backdrop.onclick = closeModal;

            // Facebook share
            document.getElementById('shareFacebook').onclick = () => {
                const text = generateFacebookPost(currentShareReport);
                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${text}</div>`;

                // After showing preview, open Facebook share
                setTimeout(() => {
                    const shareUrl = generateShareUrl(currentShareReport);
                    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(text)}`;
                    window.open(facebookUrl, '_blank', 'width=600,height=400');
                }, 500);
            };

            // Nextdoor share
            document.getElementById('shareNextdoor').onclick = () => {
                const text = generateNextdoorPost(currentShareReport);
                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${text}</div>`;

                // Copy to clipboard for pasting on Nextdoor
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úì Post copied to clipboard! Open Nextdoor and paste to share.');
                    window.open('https://nextdoor.com/', '_blank');
                });
            };

            // Copy link
            document.getElementById('shareCopyLink').onclick = () => {
                const shareUrl = generateShareUrl(currentShareReport);
                navigator.clipboard.writeText(shareUrl).then(() => {
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #10b981;">
                            ‚úì Link copied to clipboard!<br>
                            <a href="${shareUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline; font-size: 12px; margin-top: 8px; display: inline-block;">${shareUrl}</a>
                        </div>
                    `;
                });
            };

            // Email share
            document.getElementById('shareEmail').onclick = () => {
                const subject = `‚ö†Ô∏è Danger Zone Alert - TrapperTracker`;
                const body = generateEmailBody(currentShareReport);
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;

                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${body}</div>`;
            };
        }

        // Generate Facebook post template
        function generateFacebookPost(report) {
            const location = getCityFromCoords(report.latitude, report.longitude);
            return `‚ö†Ô∏èüêæ URGENT: TRAPPER ACTIVITY ALERT üêæ‚ö†Ô∏è

${location} residents - DANGER ZONE reported:

üìç Location: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
üìÖ Reported: ${formatDate(report.report_timestamp)}
‚ö†Ô∏è Details: ${report.description || 'Suspicious trapper activity in area'}

üö® KEEP YOUR PETS SAFE! üö®
Check the LIVE map before walking your pets:
üëâ trappertracker.com

PLEASE SHARE to warn your neighbors!
Every share could save a pet's life. üíîüôè

#PetSafety #TrapperAlert #${location.replace(/\s+/g, '')} #DangerZone`;
        }

        // Generate Nextdoor post template
        function generateNextdoorPost(report) {
            const location = getCityFromCoords(report.latitude, report.longitude);
            return `üèòÔ∏è Neighborhood Safety Alert

Hello neighbors,

I wanted to share important safety information about our area. A trapper activity report was recently submitted through TrapperTracker.com.

üìç Reported Location:
${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}

üìÖ Report Date: ${formatDate(report.report_timestamp)}

üìù Details:
${report.description || 'Suspicious trapper activity reported in this area'}

üêï What You Can Do:
‚úì Keep pets leashed and supervised
‚úì Check the map before walks: trappertracker.com
‚úì Report any suspicious activity
‚úì Spread awareness to neighbors

This is a community safety tool where we can all contribute to keeping our pets safe. Please check the interactive map for specific details and add any locations you're aware of.

View the live map: trappertracker.com

Stay safe, neighbors! üè†`;
        }

        // Generate email body
        function generateEmailBody(report) {
            return `‚ö†Ô∏è DANGER ZONE ALERT - TrapperTracker

A trapper activity report has been submitted to TrapperTracker:

Report #${report.report_id}
Location: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
Reported: ${formatDate(report.report_timestamp)}
Description: ${report.description || 'No description provided'}

üêæ Keep your pets safe! Check the live map before walking:
üîó https://trappertracker.com

TrapperTracker is a community-driven safety tool that helps pet owners avoid dangerous areas.

---
This alert was shared from TrapperTracker.com`;
        }

        // Generate shareable URL for a specific report
        function generateShareUrl(report) {
            const baseUrl = window.location.origin;
            return `${baseUrl}/?lat=${report.latitude}&lng=${report.longitude}&zoom=16&report=${report.report_id}`;
        }

        // Get city name from coordinates (simplified)
        function getCityFromCoords(lat, lng) {
            // This is a placeholder - in production, you'd use reverse geocoding
            // For now, return a generic location based on coordinates
            if (lat > 40 && lat < 42 && lng > -75 && lng < -73) return 'New York';
            if (lat > 33 && lat < 34 && lng > -118 && lng < -117) return 'Los Angeles';
            if (lat > 29 && lat < 31 && lng > -95 && lng < -94) return 'Houston';
            return 'Local Area';
        }

        // Setup panel toggle button
        function setupPanelToggle() {
            const toggleBtn = document.getElementById('panelToggleBtn');
            toggleBtn.addEventListener('click', toggleReportPanel);
        }

        // Toggle report panel visibility
        function toggleReportPanel() {
            isPanelVisible = !isPanelVisible;
            const panel = document.getElementById('reportListPanel');
            const mapElement = document.getElementById('map');
            const toggleBtn = document.getElementById('panelToggleBtn');

            if (isPanelVisible) {
                panel.classList.add('visible');
                mapElement.classList.add('with-panel');
                toggleBtn.innerHTML = '‚úï Close';
                updateReportList(); // Populate panel content
            } else {
                panel.classList.remove('visible');
                mapElement.classList.remove('with-panel');
                const reportCount = document.getElementById('reportCountBadge').textContent;
                toggleBtn.innerHTML = `üìã Reports (<span id="reportCountBadge">${reportCount}</span>)`;
            }
        }

        // Location search
        document.getElementById('locationSearch').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (!query) return;

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=us`,
                        { headers: { 'User-Agent': 'TrapperTracker/1.0' } }
                    );

                    const data = await response.json();
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        map.setView([lat, lng], 13);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }
        });

        // Check if user is logged in
        function isUserLoggedIn() {
            return localStorage.getItem('userRole') !== null;
        }

        // Report button - show auth or report form
        document.getElementById('reportBtn').addEventListener('click', () => {
            document.getElementById('reportOverlay').classList.add('active');
            document.getElementById('reportBackdrop').classList.add('active');

            if (isUserLoggedIn()) {
                // Show report form
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('reportForm').style.display = 'block';

                // Set location from user's current position
                if (userLat && userLng) {
                    document.getElementById('reportLocation').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                }
            } else {
                // Show auth form
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('reportForm').style.display = 'none';
            }
        });

        // Close report overlay
        function closeReportOverlay() {
            document.getElementById('reportOverlay').classList.remove('active');
            document.getElementById('reportBackdrop').classList.remove('active');

            // Remove click report marker if exists
            if (clickReportMarker) {
                map.removeLayer(clickReportMarker);
                clickReportMarker = null;
            }

            // Clear clicked coordinates
            clickedLat = null;
            clickedLng = null;
        }

        document.getElementById('closeBtn').addEventListener('click', closeReportOverlay);
        document.getElementById('closeBtnReport').addEventListener('click', closeReportOverlay);
        document.getElementById('reportBackdrop').addEventListener('click', closeReportOverlay);

        // Expand/collapse panel functionality
        function toggleExpandPanel() {
            const overlay = document.getElementById('reportOverlay');
            const expandBtn = document.getElementById('expandBtn');
            const expandBtnReport = document.getElementById('expandBtnReport');
            const isExpanded = overlay.classList.toggle('expanded');

            // Update both expand buttons' icons and titles
            const newIcon = isExpanded ? '‚óß' : '‚õ∂';
            const newTitle = isExpanded ? 'Collapse panel' : 'Expand panel';

            if (expandBtn) {
                expandBtn.textContent = newIcon;
                expandBtn.title = newTitle;
            }
            if (expandBtnReport) {
                expandBtnReport.textContent = newIcon;
                expandBtnReport.title = newTitle;
            }
        }

        document.getElementById('expandBtn').addEventListener('click', toggleExpandPanel);
        document.getElementById('expandBtnReport').addEventListener('click', toggleExpandPanel);

        // Toggle between login and register
        let isLoginMode = true;
        document.getElementById('authToggleBtn').addEventListener('click', () => {
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                document.getElementById('authTitle').textContent = 'Login to Report';
                document.getElementById('authSubmitBtn').textContent = 'Login';
                document.getElementById('confirmPasswordGroup').style.display = 'none';
                document.getElementById('passwordHint').style.display = 'none';
                document.getElementById('authToggleText').textContent = "Don't have an account?";
                document.getElementById('authToggleBtn').textContent = 'Register';
            } else {
                document.getElementById('authTitle').textContent = 'Register to Report';
                document.getElementById('authSubmitBtn').textContent = 'Register';
                document.getElementById('confirmPasswordGroup').style.display = 'block';
                document.getElementById('passwordHint').style.display = 'block';
                document.getElementById('authToggleText').textContent = 'Already have an account?';
                document.getElementById('authToggleBtn').textContent = 'Login';
            }
        });

        // Auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const passwordConfirm = document.getElementById('authPasswordConfirm').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            const messageEl = document.getElementById('authMessage');

            // Validate password match for registration
            if (!isLoginMode && password !== passwordConfirm) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Passwords do not match!';
                return;
            }

            // Get Turnstile token
            const turnstileResponse = turnstile.getResponse(document.getElementById('auth-turnstile'));
            if (!turnstileResponse) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Please complete the CAPTCHA verification.';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = isLoginMode ? 'Logging in...' : 'Registering...';

            try {
                const endpoint = isLoginMode ? '/api/login' : '/api/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, turnstileToken: turnstileResponse })
                });

                if (response.ok) {
                    const data = await response.json();

                    if (isLoginMode) {
                        // Store user role and switch to report form
                        if (data.role) {
                            localStorage.setItem('userRole', data.role);
                        }
                        messageEl.className = 'message success';
                        messageEl.textContent = '‚úì Login successful!';

                        setTimeout(() => {
                            document.getElementById('authForm').style.display = 'none';
                            document.getElementById('reportForm').style.display = 'block';
                            if (userLat && userLng) {
                                document.getElementById('reportLocation').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                            }
                        }, 1000);
                    } else {
                        // Registration success - switch to login
                        messageEl.className = 'message success';
                        messageEl.textContent = '‚úì Registration successful! Please login.';
                        document.getElementById('authForm').reset();

                        setTimeout(() => {
                            isLoginMode = true;
                            document.getElementById('authTitle').textContent = 'Login to Report';
                            document.getElementById('authSubmitBtn').textContent = 'Login';
                            document.getElementById('confirmPasswordGroup').style.display = 'none';
                            document.getElementById('passwordHint').style.display = 'none';
                            document.getElementById('authToggleText').textContent = "Don't have an account?";
                            document.getElementById('authToggleBtn').textContent = 'Register';
                            messageEl.className = 'message';
                            messageEl.textContent = '';
                        }, 2000);
                    }
                } else {
                    const errorData = await response.json();
                    messageEl.className = 'message error';
                    messageEl.textContent = errorData.error || 'Authentication failed';
                }
            } catch (error) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Network error. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isLoginMode ? 'Login' : 'Register';
                turnstile.reset(document.getElementById('auth-turnstile'));
            }
        });

        // Menu toggle
        document.getElementById('menuBtn').addEventListener('click', () => {
            document.getElementById('menuSidebar').classList.add('active');
            document.getElementById('menuBackdrop').classList.add('active');
        });

        document.getElementById('menuBackdrop').addEventListener('click', () => {
            document.getElementById('menuSidebar').classList.remove('active');
            document.getElementById('menuBackdrop').classList.remove('active');
        });

        // Submit report
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const messageEl = document.getElementById('reportMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Use clicked coordinates if available, otherwise use current location
            let lat, lng;
            if (clickedLat && clickedLng) {
                lat = clickedLat;
                lng = clickedLng;
            } else if (userLat && userLng) {
                lat = userLat;
                lng = userLng;
            } else {
                // Parse from location field as fallback
                const locationValue = document.getElementById('reportLocation').value;
                [lat, lng] = locationValue.split(',').map(s => parseFloat(s.trim()));
            }

            if (!lat || !lng) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Please set a location by clicking on the map or allowing location access.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Report';
                return;
            }

            const formData = {
                report_type: document.getElementById('reportType').value,
                latitude: lat,
                longitude: lng,
                description: document.getElementById('reportDescription').value,
                street_address: document.getElementById('reportStreet').value || null,
                city: document.getElementById('reportCity').value || null,
                state: document.getElementById('reportState').value || null
            };

            try {
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    messageEl.className = 'message success';
                    messageEl.textContent = '‚úì Report submitted successfully!';
                    document.getElementById('reportForm').reset();
                    loadDangerZones(); // Reload markers
                    setTimeout(closeReportOverlay, 2000);
                } else if (response.status === 401) {
                    messageEl.className = 'message error';
                    messageEl.textContent = 'Please login to submit reports.';
                } else {
                    messageEl.className = 'message error';
                    messageEl.textContent = 'Failed to submit report. Please try again.';
                }
            } catch (error) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Network error. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Report';
            }
        });

        // Use Current Location Button
        document.getElementById('useCurrentLocationBtn').addEventListener('click', async () => {
            const btn = document.getElementById('useCurrentLocationBtn');
            const originalText = btn.textContent;
            btn.textContent = 'üì° Getting GPS...';
            btn.disabled = true;

            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        clickedLat = lat;
                        clickedLng = lng;

                        document.getElementById('reportLocation').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                        // Add/update marker
                        if (clickReportMarker) {
                            map.removeLayer(clickReportMarker);
                        }

                        clickReportMarker = L.marker([lat, lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMCIgZmlsbD0iIzEwYjk4MSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            })
                        }).addTo(map);

                        clickReportMarker.bindPopup('üìç Your GPS location').openPopup();
                        map.setView([lat, lng], 15);

                        // Reverse geocode
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`,
                                { headers: { 'User-Agent': 'TrapperTracker/1.0' } }
                            );

                            const data = await response.json();
                            if (data && data.address) {
                                const addr = data.address;
                                const street = [addr.house_number, addr.road].filter(Boolean).join(' ');
                                if (street) document.getElementById('reportStreet').value = street;
                                if (addr.city || addr.town || addr.village) {
                                    document.getElementById('reportCity').value = addr.city || addr.town || addr.village;
                                }
                                if (addr.state) {
                                    document.getElementById('reportState').value = getStateAbbreviation(addr.state);
                                }
                            }
                        } catch (error) {
                            console.error('Reverse geocoding error:', error);
                        }

                        btn.textContent = '‚úì GPS Set';
                        btn.style.background = '#10b981';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '#3b82f6';
                            btn.disabled = false;
                        }, 2000);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Could not get your location. Please click on the map instead or enable location permissions.');
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser. Please click on the map to set location.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        // Danger Zone Toggle
        document.getElementById('dangerZoneToggle').addEventListener('click', () => {
            showDangerZones = !showDangerZones;
            const toggleBtn = document.getElementById('dangerZoneToggle');

            if (showDangerZones) {
                map.addLayer(dangerZoneCircles);
                toggleBtn.classList.add('active');
            } else {
                map.removeLayer(dangerZoneCircles);
                toggleBtn.classList.remove('active');
            }
        });

        // Alert filter button event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved filter preferences
            loadFilterPreferences();

            // Time filter buttons
            document.querySelectorAll('.alert-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update current filter
                    currentAlertFilter = e.target.dataset.filter;

                    // Update active class
                    document.querySelectorAll('.alert-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    // Save preference
                    saveFilterPreferences();

                    // Refresh panel with filtered data
                    updateReportList();
                });
            });

            // Distance filter buttons
            document.querySelectorAll('.distance-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update current distance filter
                    currentDistanceFilter = e.target.dataset.distance;

                    // Update active class
                    document.querySelectorAll('.distance-filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    // Save preference
                    saveFilterPreferences();

                    // Refresh panel with filtered data
                    updateReportList();
                });
            });

            // Search input
            const searchInput = document.getElementById('alertSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');

            searchInput.addEventListener('input', (e) => {
                currentSearchKeyword = e.target.value;

                // Show/hide clear button
                if (currentSearchKeyword) {
                    clearSearchBtn.classList.remove('hidden');
                } else {
                    clearSearchBtn.classList.add('hidden');
                }

                // Save preference
                saveFilterPreferences();

                // Refresh panel with filtered data
                updateReportList();
            });

            // Clear search button
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                currentSearchKeyword = '';
                clearSearchBtn.classList.add('hidden');
                saveFilterPreferences();
                updateReportList();
            });

            // Clear all filters button
            document.getElementById('clearAllFiltersBtn').addEventListener('click', () => {
                // Reset all filters to defaults
                currentAlertFilter = 'all';
                currentDistanceFilter = 'all';
                currentSearchKeyword = '';
                searchInput.value = '';
                clearSearchBtn.classList.add('hidden');

                // Update active states
                document.querySelectorAll('.alert-filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.alert-filter-btn[data-filter="all"]').classList.add('active');

                document.querySelectorAll('.distance-filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.distance-filter-btn[data-distance="all"]').classList.add('active');

                // Save preferences
                saveFilterPreferences();

                // Refresh panel
                updateReportList();
            });

            // Modal button event listeners
            document.getElementById('modalCloseBtn').addEventListener('click', closeReportModal);
            document.getElementById('modalDirections').addEventListener('click', getDirectionsToReport);
            document.getElementById('modalShare').addEventListener('click', shareAlert);
            document.getElementById('modalCenterMap').addEventListener('click', centerMapOnReportFromModal);
            document.getElementById('modalFlag').addEventListener('click', flagReport);

            // Close modal when clicking overlay background
            document.getElementById('reportModal').addEventListener('click', (e) => {
                if (e.target.id === 'reportModal') {
                    closeReportModal();
                }
            });
        });

        // Initialize
        window.addEventListener('load', () => {
            initMap();
            checkLoggedInUser();
        });
    </script>
</body>
</html>
