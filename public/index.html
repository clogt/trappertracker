<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrapperTracker - Pet Safety Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* Fixed Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #1f2937;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .menu-btn, .support-link {
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            padding: 8px 12px;
            cursor: pointer;
            text-decoration: none;
        }

        .user-indicator {
            font-size: 13px;
            color: #10b981;
            padding: 6px 10px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            display: none;
        }

        .user-indicator.visible {
            display: block;
        }

        .menu-btn {
            font-size: 24px;
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            transition: right 0.3s ease;
        }

        #map.with-panel {
            right: 320px;
        }

        /* Report List Panel */
        .report-list-panel {
            position: fixed;
            top: 60px;
            right: -320px;
            width: 320px;
            bottom: 0;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            z-index: 900;
            overflow-y: auto;
            transition: right 0.3s ease;
        }

        .report-list-panel.visible {
            right: 0;
        }

        .report-list-header {
            position: sticky;
            top: 0;
            background: #1f2937;
            color: white;
            padding: 16px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .report-list-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .report-count {
            font-size: 13px;
            color: #9ca3af;
        }

        .report-list-items {
            padding: 12px;
        }

        .report-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            border-color: #ef4444;
            transform: translateX(-2px);
        }

        .report-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .report-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .report-card-date {
            font-size: 11px;
            color: #6b7280;
        }

        .report-card-location {
            font-size: 12px;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .report-card-description {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .report-card-actions {
            display: flex;
            gap: 8px;
        }

        .report-card-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-share {
            background: #10b981;
            color: white;
        }

        .btn-share:hover {
            background: #059669;
        }

        .panel-toggle-btn {
            position: fixed;
            top: 80px;
            right: 16px;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            z-index: 950;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            transition: all 0.2s;
        }

        .panel-toggle-btn:hover {
            background: #f3f4f6;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* Custom Cluster Markers */
        .marker-cluster-small {
            background-color: rgba(239, 68, 68, 0.6);
        }

        .marker-cluster-small div {
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            font-weight: bold;
        }

        .marker-cluster-medium {
            background-color: rgba(239, 68, 68, 0.5);
        }

        .marker-cluster-medium div {
            background-color: rgba(239, 68, 68, 0.7);
            color: white;
            font-weight: bold;
        }

        .marker-cluster-large {
            background-color: rgba(220, 38, 38, 0.5);
        }

        .marker-cluster-large div {
            background-color: rgba(220, 38, 38, 0.7);
            color: white;
            font-weight: bold;
        }

        /* Share Modal */
        .share-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .share-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 2001;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }

        .share-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
        }

        .share-modal-close {
            background: none;
            border: none;
            font-size: 32px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .share-modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .share-modal-body {
            padding: 24px;
        }

        .share-report-preview {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .share-platform-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .share-platform-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .share-platform-btn:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .share-platform-btn .btn-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .share-platform-btn .btn-title {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .share-platform-btn .btn-subtitle {
            font-size: 11px;
            color: #6b7280;
        }

        .facebook-btn:hover {
            border-color: #1877f2;
            background: #f0f7ff;
        }

        .nextdoor-btn:hover {
            border-color: #00b246;
            background: #f0fdf4;
        }

        .copy-btn:hover {
            border-color: #8b5cf6;
            background: #faf5ff;
        }

        .email-btn:hover {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .share-preview-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }

        .share-preview-header {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .share-preview-content {
            background: white;
            border-radius: 6px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: #1f2937;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .report-list-panel {
                width: 100%;
                right: -100%;
            }

            .report-list-panel.visible {
                right: 0;
            }

            #map.with-panel {
                right: 0;
            }

            .panel-toggle-btn {
                right: 16px;
                top: 140px;
            }

            .share-platform-buttons {
                grid-template-columns: 1fr;
            }

            .share-modal {
                width: 95%;
                max-height: 90vh;
            }
        }

        /* Search Input Overlay */
        .search-overlay {
            position: fixed;
            top: 76px;
            left: 16px;
            right: 16px;
            z-index: 500;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Report Button Overlay */
        .report-btn-container {
            position: fixed;
            bottom: 24px;
            left: 16px;
            right: 16px;
            z-index: 500;
        }

        .report-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
            cursor: pointer;
        }

        /* Report Form Overlay */
        .report-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }

        .report-overlay.active {
            transform: translateY(0);
        }

        .report-overlay-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .report-overlay-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .report-form {
            padding: 24px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .report-title {
            font-size: 22px;
            font-weight: bold;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 8px;
        }

        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            display: block;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            display: block;
        }

        /* Menu Sidebar */
        .menu-sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: #1f2937;
            z-index: 3000;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .menu-sidebar.active {
            left: 0;
        }

        .menu-sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .menu-sidebar-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .menu-items {
            padding: 20px;
        }

        .menu-item {
            display: block;
            padding: 14px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .menu-item:active {
            background: #374151;
        }
    </style>
</head>
<body>
    <!-- Fixed Header -->
    <div class="header">
        <button class="menu-btn" id="menuBtn">‚ò∞</button>
        <div class="header-title">TrapperTracker</div>
        <div class="header-right">
            <span class="user-indicator" id="userIndicator"></span>
            <a href="/donate.html" class="support-link">Support</a>
        </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Search Input Overlay -->
    <div class="search-overlay">
        <input type="text" class="search-input" id="locationSearch" placeholder="Enter city or ZIP code...">
    </div>

    <!-- Report Button Overlay -->
    <div class="report-btn-container">
        <button class="report-btn" id="reportBtn">‚ö†Ô∏è Report Danger Zone</button>
    </div>

    <!-- Report Form Overlay -->
    <div class="report-overlay-backdrop" id="reportBackdrop"></div>
    <div class="report-overlay" id="reportOverlay">
        <!-- Auth Form (Login/Register) -->
        <form class="report-form" id="authForm" style="display: none;">
            <div class="report-header">
                <h2 class="report-title" id="authTitle">Login to Report</h2>
                <button type="button" class="close-btn" id="closeBtn">√ó</button>
            </div>

            <div id="authMessage" class="message"></div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="authEmail" required>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="authPassword" required minlength="8">
                <p style="font-size: 12px; color: #6b7280; margin-top: 4px;" id="passwordHint">Min 8 characters, 1 uppercase, 1 lowercase, 1 number, 1 special character</p>
            </div>

            <div class="form-group" id="confirmPasswordGroup" style="display: none;">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="authPasswordConfirm" minlength="8">
            </div>

            <!-- Turnstile CAPTCHA -->
            <div class="form-group">
                <div class="cf-turnstile" id="auth-turnstile" data-sitekey="0x4AAAAAAB_w9INZSbixJ5Nk" data-theme="light"></div>
            </div>

            <button type="submit" class="submit-btn" id="authSubmitBtn">Login</button>

            <p style="text-align: center; margin-top: 16px; font-size: 14px; color: #6b7280;">
                <span id="authToggleText">Don't have an account?</span>
                <button type="button" id="authToggleBtn" style="background: none; border: none; color: #3b82f6; text-decoration: underline; cursor: pointer;">Register</button>
            </p>
        </form>

        <!-- Report Form -->
        <form class="report-form" id="reportForm" style="display: none;">
            <div class="report-header">
                <h2 class="report-title">Report Danger Zone</h2>
                <button type="button" class="close-btn" id="closeBtnReport">√ó</button>
            </div>

            <div id="reportMessage" class="message"></div>

            <div class="form-group">
                <label class="form-label">Report Type</label>
                <select class="form-select" id="reportType" required>
                    <option value="dangerZone">Danger Zone</option>
                    <option value="lostPet">Lost Pet</option>
                    <option value="foundPet">Found Pet</option>
                    <option value="dangerousAnimal">Dangerous Animal</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Location</label>
                <input type="text" class="form-input" id="reportLocation" readonly required>
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="reportDescription" placeholder="Describe the danger or situation..." required></textarea>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">Submit Report</button>
        </form>
    </div>

    <!-- Menu Sidebar -->
    <div class="menu-sidebar-backdrop" id="menuBackdrop"></div>
    <div class="menu-sidebar" id="menuSidebar">
        <div class="menu-items">
            <a href="/" class="menu-item">üè† Home</a>
            <a href="/advanced.html" class="menu-item">‚öôÔ∏è Advanced Features</a>
            <a href="/dashboard.html" class="menu-item">üìä Dashboard</a>
            <a href="/login.html" class="menu-item">üîê Login</a>
            <a href="/donate.html" class="menu-item">‚ô•Ô∏è Support Us</a>
        </div>
    </div>

    <!-- Report List Panel Toggle Button -->
    <button class="panel-toggle-btn" id="panelToggleBtn" style="display: none;">
        üìã Reports (<span id="reportCountBadge">0</span>)
    </button>

    <!-- Report List Panel -->
    <div class="report-list-panel" id="reportListPanel">
        <div class="report-list-header">
            <div class="report-list-title">‚ö†Ô∏è Active Danger Zones</div>
            <div class="report-count"><span id="panelReportCount">0</span> reports in this area</div>
        </div>
        <div class="report-list-items" id="reportListItems">
            <!-- Report cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Social Share Modal -->
    <div class="share-modal-backdrop" id="shareModalBackdrop" style="display: none;"></div>
    <div class="share-modal" id="shareModal" style="display: none;">
        <div class="share-modal-header">
            <h2 class="share-modal-title">üì§ Share Danger Zone Alert</h2>
            <button class="share-modal-close" id="shareModalClose">√ó</button>
        </div>

        <div class="share-modal-body">
            <div class="share-report-preview" id="shareReportPreview">
                <!-- Report preview will be inserted here -->
            </div>

            <div class="share-platform-buttons">
                <button class="share-platform-btn facebook-btn" id="shareFacebook">
                    <span class="btn-icon">üìò</span>
                    <div>
                        <div class="btn-title">Facebook</div>
                        <div class="btn-subtitle">Group & Timeline optimized</div>
                    </div>
                </button>

                <button class="share-platform-btn nextdoor-btn" id="shareNextdoor">
                    <span class="btn-icon">üèòÔ∏è</span>
                    <div>
                        <div class="btn-title">Nextdoor</div>
                        <div class="btn-subtitle">Neighborhood format</div>
                    </div>
                </button>

                <button class="share-platform-btn copy-btn" id="shareCopyLink">
                    <span class="btn-icon">üîó</span>
                    <div>
                        <div class="btn-title">Copy Link</div>
                        <div class="btn-subtitle">Share anywhere</div>
                    </div>
                </button>

                <button class="share-platform-btn email-btn" id="shareEmail">
                    <span class="btn-icon">üìß</span>
                    <div>
                        <div class="btn-title">Email</div>
                        <div class="btn-subtitle">Send to friends</div>
                    </div>
                </button>
            </div>

            <div class="share-preview-section">
                <div class="share-preview-header">Preview:</div>
                <div class="share-preview-content" id="sharePreviewContent">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">Select a platform to preview the message</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let userMarker;
        let userLat, userLng;
        let markerClusterGroup;
        let allDangerZones = [];
        let isPanelVisible = false;

        // Check and display logged-in user
        async function checkLoggedInUser() {
            try {
                const response = await fetch('/api/auth/verify', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    const userIndicator = document.getElementById('userIndicator');
                    if (data.email) {
                        userIndicator.textContent = `üë§ ${data.email}`;
                        userIndicator.classList.add('visible');
                    }
                }
            } catch (error) {
                console.log('User not logged in');
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: false
            }).setView([39.8283, -98.5795], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Add zoom control to bottom right
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);

            // Initialize marker cluster group
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 60,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count >= 20) size = 'large';
                    else if (count >= 10) size = 'medium';

                    return L.divIcon({
                        html: `<div><span>${count}</span></div>`,
                        className: `marker-cluster marker-cluster-${size}`,
                        iconSize: L.point(40, 40)
                    });
                }
            });

            map.addLayer(markerClusterGroup);

            // Listen for map movements to update report list
            map.on('zoomend moveend', updateReportList);

            // Request user location
            requestUserLocation();

            // Load danger zones
            loadDangerZones();

            // Setup panel toggle button
            setupPanelToggle();
        }

        // Request user's location
        function requestUserLocation() {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLng = position.coords.longitude;

                        // Center map on user
                        map.setView([userLat, userLng], 13);

                        // Add user marker
                        userMarker = L.marker([userLat, userLng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxMCIgZmlsbD0iIzM4OTVmZiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+',
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);

                        userMarker.bindPopup('Your Location');
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                    }
                );
            }
        }

        // Load danger zones with clustering
        async function loadDangerZones() {
            try {
                const response = await fetch('/api/reports');
                if (!response.ok) {
                    console.error('Failed to fetch reports:', response.status);
                    return;
                }

                const data = await response.json();
                console.log('Loaded reports from API:', data.length);

                allDangerZones = data.filter(r => r.report_type === 'Danger Zone');
                console.log('Filtered danger zones:', allDangerZones.length);

                // Clear existing markers
                markerClusterGroup.clearLayers();

                // Add markers to cluster group
                allDangerZones.forEach(report => {
                    const marker = L.marker([report.latitude, report.longitude], {
                        icon: L.icon({
                            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSIxNCIgZmlsbD0iI2VmNDQ0NCIgc3Ryb2tlPSIjOTkxYjFiIiBzdHJva2Utd2lkdGg9IjIiLz48dGV4dCB4PSIxNiIgeT0iMjIiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIj4hPC90ZXh0Pjwvc3ZnPg==',
                            iconSize: [32, 32]
                        })
                    });

                    // Store report data in marker for later access
                    marker.reportData = report;

                    // Create popup content
                    const popupContent = `
                        <div style="max-width: 200px;">
                            <b>‚ö†Ô∏è Danger Zone</b><br>
                            <small>${formatDate(report.report_timestamp)}</small><br>
                            ${report.description || 'No details'}
                        </div>
                    `;
                    marker.bindPopup(popupContent);

                    markerClusterGroup.addLayer(marker);
                });

                console.log('Added', allDangerZones.length, 'markers to cluster group');
                console.log('Total layers in cluster group:', markerClusterGroup.getLayers().length);

                // If geolocation hasn't positioned the map yet and we have markers, fit bounds to show all markers
                if (allDangerZones.length > 0 && !userMarker) {
                    setTimeout(() => {
                        if (!userMarker && markerClusterGroup.getLayers().length > 0) {
                            const bounds = markerClusterGroup.getBounds();
                            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                            console.log('Fitted map to show all markers');
                        }
                    }, 1000);
                }

                // Update report list after loading
                updateReportList();

            } catch (error) {
                console.error('Error loading danger zones:', error);
            }
        }

        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            const date = new Date(timestamp);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString();
        }

        // Update report list based on visible map area
        function updateReportList() {
            const zoom = map.getZoom();
            const bounds = map.getBounds();

            // Get reports visible in current bounds
            const visibleReports = allDangerZones.filter(report => {
                return bounds.contains([report.latitude, report.longitude]);
            });

            const reportCount = visibleReports.length;

            // Show panel if conditions met: zoom >= 13 AND 10+ reports
            const shouldShowPanel = zoom >= 13 && reportCount >= 10;

            // Update toggle button
            const toggleBtn = document.getElementById('panelToggleBtn');
            const reportCountBadge = document.getElementById('reportCountBadge');

            if (shouldShowPanel) {
                toggleBtn.style.display = 'block';
                reportCountBadge.textContent = reportCount;
            } else {
                toggleBtn.style.display = 'none';
                // Hide panel if conditions no longer met
                if (isPanelVisible) {
                    toggleReportPanel();
                }
            }

            // If panel is visible, update its content
            if (isPanelVisible) {
                renderReportList(visibleReports);
            }
        }

        // Render report cards in the panel
        function renderReportList(reports) {
            const panelReportCount = document.getElementById('panelReportCount');
            const reportListItems = document.getElementById('reportListItems');

            panelReportCount.textContent = reports.length;

            if (reports.length === 0) {
                reportListItems.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">No reports in this area</div>';
                return;
            }

            // Sort by most recent first
            const sortedReports = [...reports].sort((a, b) => {
                return new Date(b.report_timestamp) - new Date(a.report_timestamp);
            });

            // Limit to 50 reports to prevent performance issues
            const displayReports = sortedReports.slice(0, 50);

            reportListItems.innerHTML = displayReports.map((report, index) => `
                <div class="report-card" data-report-id="${report.report_id}" data-lat="${report.latitude}" data-lng="${report.longitude}">
                    <div class="report-card-header">
                        <div class="report-card-title">Report #${report.report_id}</div>
                        <div class="report-card-date">${formatDate(report.report_timestamp)}</div>
                    </div>
                    <div class="report-card-location">
                        üìç ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
                    </div>
                    <div class="report-card-description">
                        ${report.description || 'No description provided'}
                    </div>
                    <div class="report-card-actions">
                        <button class="report-card-btn btn-view" onclick="centerMapOnReport(${report.latitude}, ${report.longitude})">
                            üìç View
                        </button>
                        <button class="report-card-btn btn-share" onclick="shareReport(${report.report_id})">
                            üì§ Share
                        </button>
                    </div>
                </div>
            `).join('');

            if (reports.length > 50) {
                reportListItems.innerHTML += `
                    <div style="padding: 16px; text-align: center; color: #6b7280; font-size: 12px;">
                        Showing 50 of ${reports.length} reports. Zoom in for more detail.
                    </div>
                `;
            }
        }

        // Center map on specific report
        function centerMapOnReport(lat, lng) {
            map.setView([lat, lng], 16, { animate: true });
        }

        // Share report - open modal with sharing options
        let currentShareReport = null;

        function shareReport(reportId) {
            // Find the report data
            const report = allDangerZones.find(r => r.report_id === reportId);
            if (!report) {
                console.error('Report not found:', reportId);
                return;
            }

            currentShareReport = report;

            // Show modal
            document.getElementById('shareModalBackdrop').style.display = 'block';
            document.getElementById('shareModal').style.display = 'block';

            // Populate report preview
            const previewEl = document.getElementById('shareReportPreview');
            previewEl.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">Report #${report.report_id}</div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                    üìç ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
                </div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                    üìÖ ${formatDate(report.report_timestamp)}
                </div>
                <div style="font-size: 14px; color: #1f2937;">
                    ${report.description || 'No description provided'}
                </div>
            `;

            // Setup share button handlers
            setupShareHandlers();
        }

        // Setup share modal handlers
        function setupShareHandlers() {
            const modal = document.getElementById('shareModal');
            const backdrop = document.getElementById('shareModalBackdrop');
            const closeBtn = document.getElementById('shareModalClose');
            const previewContent = document.getElementById('sharePreviewContent');

            // Close modal
            const closeModal = () => {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
                currentShareReport = null;
            };

            closeBtn.onclick = closeModal;
            backdrop.onclick = closeModal;

            // Facebook share
            document.getElementById('shareFacebook').onclick = () => {
                const text = generateFacebookPost(currentShareReport);
                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${text}</div>`;

                // After showing preview, open Facebook share
                setTimeout(() => {
                    const shareUrl = generateShareUrl(currentShareReport);
                    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(text)}`;
                    window.open(facebookUrl, '_blank', 'width=600,height=400');
                }, 500);
            };

            // Nextdoor share
            document.getElementById('shareNextdoor').onclick = () => {
                const text = generateNextdoorPost(currentShareReport);
                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${text}</div>`;

                // Copy to clipboard for pasting on Nextdoor
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úì Post copied to clipboard! Open Nextdoor and paste to share.');
                    window.open('https://nextdoor.com/', '_blank');
                });
            };

            // Copy link
            document.getElementById('shareCopyLink').onclick = () => {
                const shareUrl = generateShareUrl(currentShareReport);
                navigator.clipboard.writeText(shareUrl).then(() => {
                    previewContent.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #10b981;">
                            ‚úì Link copied to clipboard!<br>
                            <a href="${shareUrl}" target="_blank" style="color: #3b82f6; text-decoration: underline; font-size: 12px; margin-top: 8px; display: inline-block;">${shareUrl}</a>
                        </div>
                    `;
                });
            };

            // Email share
            document.getElementById('shareEmail').onclick = () => {
                const subject = `‚ö†Ô∏è Danger Zone Alert - TrapperTracker`;
                const body = generateEmailBody(currentShareReport);
                const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoUrl;

                previewContent.innerHTML = `<div style="white-space: pre-wrap;">${body}</div>`;
            };
        }

        // Generate Facebook post template
        function generateFacebookPost(report) {
            const location = getCityFromCoords(report.latitude, report.longitude);
            return `‚ö†Ô∏èüêæ URGENT: TRAPPER ACTIVITY ALERT üêæ‚ö†Ô∏è

${location} residents - DANGER ZONE reported:

üìç Location: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
üìÖ Reported: ${formatDate(report.report_timestamp)}
‚ö†Ô∏è Details: ${report.description || 'Suspicious trapper activity in area'}

üö® KEEP YOUR PETS SAFE! üö®
Check the LIVE map before walking your pets:
üëâ trappertracker.com

PLEASE SHARE to warn your neighbors!
Every share could save a pet's life. üíîüôè

#PetSafety #TrapperAlert #${location.replace(/\s+/g, '')} #DangerZone`;
        }

        // Generate Nextdoor post template
        function generateNextdoorPost(report) {
            const location = getCityFromCoords(report.latitude, report.longitude);
            return `üèòÔ∏è Neighborhood Safety Alert

Hello neighbors,

I wanted to share important safety information about our area. A trapper activity report was recently submitted through TrapperTracker.com.

üìç Reported Location:
${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}

üìÖ Report Date: ${formatDate(report.report_timestamp)}

üìù Details:
${report.description || 'Suspicious trapper activity reported in this area'}

üêï What You Can Do:
‚úì Keep pets leashed and supervised
‚úì Check the map before walks: trappertracker.com
‚úì Report any suspicious activity
‚úì Spread awareness to neighbors

This is a community safety tool where we can all contribute to keeping our pets safe. Please check the interactive map for specific details and add any locations you're aware of.

View the live map: trappertracker.com

Stay safe, neighbors! üè†`;
        }

        // Generate email body
        function generateEmailBody(report) {
            return `‚ö†Ô∏è DANGER ZONE ALERT - TrapperTracker

A trapper activity report has been submitted to TrapperTracker:

Report #${report.report_id}
Location: ${report.latitude.toFixed(4)}, ${report.longitude.toFixed(4)}
Reported: ${formatDate(report.report_timestamp)}
Description: ${report.description || 'No description provided'}

üêæ Keep your pets safe! Check the live map before walking:
üîó https://trappertracker.com

TrapperTracker is a community-driven safety tool that helps pet owners avoid dangerous areas.

---
This alert was shared from TrapperTracker.com`;
        }

        // Generate shareable URL for a specific report
        function generateShareUrl(report) {
            const baseUrl = window.location.origin;
            return `${baseUrl}/?lat=${report.latitude}&lng=${report.longitude}&zoom=16&report=${report.report_id}`;
        }

        // Get city name from coordinates (simplified)
        function getCityFromCoords(lat, lng) {
            // This is a placeholder - in production, you'd use reverse geocoding
            // For now, return a generic location based on coordinates
            if (lat > 40 && lat < 42 && lng > -75 && lng < -73) return 'New York';
            if (lat > 33 && lat < 34 && lng > -118 && lng < -117) return 'Los Angeles';
            if (lat > 29 && lat < 31 && lng > -95 && lng < -94) return 'Houston';
            return 'Local Area';
        }

        // Setup panel toggle button
        function setupPanelToggle() {
            const toggleBtn = document.getElementById('panelToggleBtn');
            toggleBtn.addEventListener('click', toggleReportPanel);
        }

        // Toggle report panel visibility
        function toggleReportPanel() {
            isPanelVisible = !isPanelVisible;
            const panel = document.getElementById('reportListPanel');
            const mapElement = document.getElementById('map');
            const toggleBtn = document.getElementById('panelToggleBtn');

            if (isPanelVisible) {
                panel.classList.add('visible');
                mapElement.classList.add('with-panel');
                toggleBtn.innerHTML = '‚úï Close';
                updateReportList(); // Populate panel content
            } else {
                panel.classList.remove('visible');
                mapElement.classList.remove('with-panel');
                const reportCount = document.getElementById('reportCountBadge').textContent;
                toggleBtn.innerHTML = `üìã Reports (<span id="reportCountBadge">${reportCount}</span>)`;
            }
        }

        // Location search
        document.getElementById('locationSearch').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (!query) return;

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=us`,
                        { headers: { 'User-Agent': 'TrapperTracker/1.0' } }
                    );

                    const data = await response.json();
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        map.setView([lat, lng], 13);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }
        });

        // Check if user is logged in
        function isUserLoggedIn() {
            return localStorage.getItem('userRole') !== null;
        }

        // Report button - show auth or report form
        document.getElementById('reportBtn').addEventListener('click', () => {
            document.getElementById('reportOverlay').classList.add('active');
            document.getElementById('reportBackdrop').classList.add('active');

            if (isUserLoggedIn()) {
                // Show report form
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('reportForm').style.display = 'block';

                // Set location from user's current position
                if (userLat && userLng) {
                    document.getElementById('reportLocation').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                }
            } else {
                // Show auth form
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('reportForm').style.display = 'none';
            }
        });

        // Close report overlay
        function closeReportOverlay() {
            document.getElementById('reportOverlay').classList.remove('active');
            document.getElementById('reportBackdrop').classList.remove('active');
        }

        document.getElementById('closeBtn').addEventListener('click', closeReportOverlay);
        document.getElementById('closeBtnReport').addEventListener('click', closeReportOverlay);
        document.getElementById('reportBackdrop').addEventListener('click', closeReportOverlay);

        // Toggle between login and register
        let isLoginMode = true;
        document.getElementById('authToggleBtn').addEventListener('click', () => {
            isLoginMode = !isLoginMode;

            if (isLoginMode) {
                document.getElementById('authTitle').textContent = 'Login to Report';
                document.getElementById('authSubmitBtn').textContent = 'Login';
                document.getElementById('confirmPasswordGroup').style.display = 'none';
                document.getElementById('passwordHint').style.display = 'none';
                document.getElementById('authToggleText').textContent = "Don't have an account?";
                document.getElementById('authToggleBtn').textContent = 'Register';
            } else {
                document.getElementById('authTitle').textContent = 'Register to Report';
                document.getElementById('authSubmitBtn').textContent = 'Register';
                document.getElementById('confirmPasswordGroup').style.display = 'block';
                document.getElementById('passwordHint').style.display = 'block';
                document.getElementById('authToggleText').textContent = 'Already have an account?';
                document.getElementById('authToggleBtn').textContent = 'Login';
            }
        });

        // Auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const passwordConfirm = document.getElementById('authPasswordConfirm').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            const messageEl = document.getElementById('authMessage');

            // Validate password match for registration
            if (!isLoginMode && password !== passwordConfirm) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Passwords do not match!';
                return;
            }

            // Get Turnstile token
            const turnstileResponse = turnstile.getResponse(document.getElementById('auth-turnstile'));
            if (!turnstileResponse) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Please complete the CAPTCHA verification.';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = isLoginMode ? 'Logging in...' : 'Registering...';

            try {
                const endpoint = isLoginMode ? '/api/login' : '/api/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, turnstileToken: turnstileResponse })
                });

                if (response.ok) {
                    const data = await response.json();

                    if (isLoginMode) {
                        // Store user role and switch to report form
                        if (data.role) {
                            localStorage.setItem('userRole', data.role);
                        }
                        messageEl.className = 'message success';
                        messageEl.textContent = '‚úì Login successful!';

                        setTimeout(() => {
                            document.getElementById('authForm').style.display = 'none';
                            document.getElementById('reportForm').style.display = 'block';
                            if (userLat && userLng) {
                                document.getElementById('reportLocation').value = `${userLat.toFixed(6)}, ${userLng.toFixed(6)}`;
                            }
                        }, 1000);
                    } else {
                        // Registration success - switch to login
                        messageEl.className = 'message success';
                        messageEl.textContent = '‚úì Registration successful! Please login.';
                        document.getElementById('authForm').reset();

                        setTimeout(() => {
                            isLoginMode = true;
                            document.getElementById('authTitle').textContent = 'Login to Report';
                            document.getElementById('authSubmitBtn').textContent = 'Login';
                            document.getElementById('confirmPasswordGroup').style.display = 'none';
                            document.getElementById('passwordHint').style.display = 'none';
                            document.getElementById('authToggleText').textContent = "Don't have an account?";
                            document.getElementById('authToggleBtn').textContent = 'Register';
                            messageEl.className = 'message';
                            messageEl.textContent = '';
                        }, 2000);
                    }
                } else {
                    const errorData = await response.json();
                    messageEl.className = 'message error';
                    messageEl.textContent = errorData.error || 'Authentication failed';
                }
            } catch (error) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Network error. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isLoginMode ? 'Login' : 'Register';
                turnstile.reset(document.getElementById('auth-turnstile'));
            }
        });

        // Menu toggle
        document.getElementById('menuBtn').addEventListener('click', () => {
            document.getElementById('menuSidebar').classList.add('active');
            document.getElementById('menuBackdrop').classList.add('active');
        });

        document.getElementById('menuBackdrop').addEventListener('click', () => {
            document.getElementById('menuSidebar').classList.remove('active');
            document.getElementById('menuBackdrop').classList.remove('active');
        });

        // Submit report
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const messageEl = document.getElementById('reportMessage');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const formData = {
                report_type: document.getElementById('reportType').value,
                latitude: userLat,
                longitude: userLng,
                description: document.getElementById('reportDescription').value
            };

            try {
                const response = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    messageEl.className = 'message success';
                    messageEl.textContent = '‚úì Report submitted successfully!';
                    document.getElementById('reportForm').reset();
                    loadDangerZones(); // Reload markers
                    setTimeout(closeReportOverlay, 2000);
                } else if (response.status === 401) {
                    messageEl.className = 'message error';
                    messageEl.textContent = 'Please login to submit reports.';
                } else {
                    messageEl.className = 'message error';
                    messageEl.textContent = 'Failed to submit report. Please try again.';
                }
            } catch (error) {
                messageEl.className = 'message error';
                messageEl.textContent = 'Network error. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Report';
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            initMap();
            checkLoggedInUser();
        });
    </script>
</body>
</html>
